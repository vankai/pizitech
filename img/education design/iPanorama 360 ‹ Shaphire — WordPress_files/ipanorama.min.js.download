!function(e,t){t((e=e||self).IPANORAMA=e.IPANORAMA||{})}(this,function(root){"use strict";var VERSION="1.5.16",HOWLER=function(){var e=function(){this.init()};e.prototype={init:function(){var e=this||w;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||w;if(e=parseFloat(e),t.ctx||h(),void 0!==e&&0<=e&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,w.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var o=t._howls[n]._getSoundIds(),i=0;i<o.length;i++){var a=t._howls[n]._soundById(o[i]);a&&a._node&&(a._node.volume=a._volume*e)}return t}return t._volume},mute:function(e){var t=this||w;t.ctx||h(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,w.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var o=t._howls[n]._getSoundIds(),i=0;i<o.length;i++){var a=t._howls[n]._soundById(o[i]);a&&a._node&&(a._node.muted=!!e||a._muted)}return t},unload:function(){for(var e=this||w,t=e._howls.length-1;0<=t;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,h()),e},codecs:function(e){return(this||w)._codecs[e.replace(/^x-/,"")]},_setup:function(){var t=this||w;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if("undefined"!=typeof Audio)try{void 0===(new Audio).oncanplaythrough&&(t._canPlayEvent="canplay")}catch(e){t.noAudio=!0}else t.noAudio=!0;try{(new Audio).muted&&(t.noAudio=!0)}catch(e){}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||w,e=null;try{e="undefined"!=typeof Audio?new Audio:null}catch(e){return t}if(!e||"function"!=typeof e.canPlayType)return t;var n=e.canPlayType("audio/mpeg;").replace(/^no$/,""),o=t._navigator&&t._navigator.userAgent.match(/OPR\/([0-6].)/g),i=o&&parseInt(o[0].split("/")[1],10)<33;return t._codecs={mp3:!(i||!n&&!e.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!n,opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!e.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!e.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(e.canPlayType("audio/x-flac;")||e.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var s=this||w,e=/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi|Chrome|Safari/i.test(s._navigator&&s._navigator.userAgent);if(!s._audioUnlocked&&s.ctx&&e){s._audioUnlocked=!1,s.autoUnlock=!1,s._mobileUnloaded||44100===s.ctx.sampleRate||(s._mobileUnloaded=!0,s.unload()),s._scratchBuffer=s.ctx.createBuffer(1,1,22050);var c=function(e){for(var t=0;t<s.html5PoolSize;t++){var n=new Audio;n._unlocked=!0,s._releaseHtml5Audio(n)}for(t=0;t<s._howls.length;t++)if(!s._howls[t]._webAudio)for(var o=s._howls[t]._getSoundIds(),i=0;i<o.length;i++){var a=s._howls[t]._soundById(o[i]);a&&a._node&&!a._node._unlocked&&(a._node._unlocked=!0,a._node.load())}s._autoResume();var r=s.ctx.createBufferSource();r.buffer=s._scratchBuffer,r.connect(s.ctx.destination),void 0===r.start?r.noteOn(0):r.start(0),"function"==typeof s.ctx.resume&&s.ctx.resume(),r.onended=function(){r.disconnect(0),s._audioUnlocked=!0,document.removeEventListener("touchstart",c,!0),document.removeEventListener("touchend",c,!0),document.removeEventListener("click",c,!0);for(var e=0;e<s._howls.length;e++)s._howls[e]._emit("unlock")}};return document.addEventListener("touchstart",c,!0),document.addEventListener("touchend",c,!0),document.addEventListener("click",c,!0),s}},_obtainHtml5Audio:function(){var e=this||w;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=(new Audio).play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var t=this||w;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&w.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio)for(var n=0;n<e._howls[t]._sounds.length;n++)if(!e._howls[t]._sounds[n]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){e.autoSuspend&&(e._suspendTimer=null,e.state="suspending",e.ctx.suspend().then(function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())}))},3e4),e}},_autoResume:function(){var t=this;if(t.ctx&&void 0!==t.ctx.resume&&w.usingWebAudio)return"running"===t.state&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):"suspended"===t.state?(t.ctx.resume().then(function(){t.state="running";for(var e=0;e<t._howls.length;e++)t._howls[e]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):"suspending"===t.state&&(t._resumeAfterSuspend=!0),t}};var w=new e,t=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")};t.prototype={init:function(e){var t=this;return w.ctx||h(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhrWithCredentials=e.xhrWithCredentials||!1,t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=w.usingWebAudio&&!t._html5,void 0!==w.ctx&&w.ctx&&w.autoUnlock&&w._unlockAudio(),w._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&t.load(),t},load:function(){var e=this,t=null;if(w.noAudio)e._emit("loaderror",null,"No audio support.");else{"string"==typeof e._src&&(e._src=[e._src]);for(var n=0;n<e._src.length;n++){var o,i;if(e._format&&e._format[n])o=e._format[n];else{if("string"!=typeof(i=e._src[n])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(o=/^data:audio\/([^;,]+);/i.exec(i))||(o=/\.([^.]+)$/.exec(i.split("?",1)[0])),o&&(o=o[1].toLowerCase())}if(o||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),o&&w.codecs(o)){t=e._src[n];break}}if(t)return e._src=t,e._state="loading","https:"===window.location.protocol&&"http:"===t.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new a(e),e._webAudio&&s(e),e;e._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(t,n){var o=this,e=null;if("number"==typeof t)e=t,t=null;else{if("string"==typeof t&&"loaded"===o._state&&!o._sprite[t])return null;if(void 0===t&&(t="__default",!o._playLock)){for(var i=0,a=0;a<o._sounds.length;a++)o._sounds[a]._paused&&!o._sounds[a]._ended&&(i++,e=o._sounds[a]._id);1===i?t=null:e=null}}var r=e?o._soundById(e):o._inactiveSound();if(!r)return null;if(e&&!t&&(t=r._sprite||"__default"),"loaded"!==o._state){r._sprite=t,r._ended=!1;var s=r._id;return o._queue.push({event:"play",action:function(){o.play(s)}}),s}if(e&&!r._paused)return n||o._loadQueue("play"),r._id;o._webAudio&&w._autoResume();var c=Math.max(0,0<r._seek?r._seek:o._sprite[t][0]/1e3),l=Math.max(0,(o._sprite[t][0]+o._sprite[t][1])/1e3-c),u=1e3*l/Math.abs(r._rate),h=o._sprite[t][0]/1e3,d=(o._sprite[t][0]+o._sprite[t][1])/1e3,p=!(!r._loop&&!o._sprite[t][2]);r._sprite=t,r._ended=!1;var m=function(){r._paused=!1,r._seek=c,r._start=h,r._stop=d,r._loop=p};if(!(d<=c)){var f=r._node;if(o._webAudio){var v=function(){o._playLock=!1,m(),o._refreshBuffer(r);var e=r._muted||o._muted?0:r._volume;f.gain.setValueAtTime(e,w.ctx.currentTime),r._playStart=w.ctx.currentTime,void 0===f.bufferSource.start?r._loop?f.bufferSource.noteGrainOn(0,c,86400):f.bufferSource.noteGrainOn(0,c,l):r._loop?f.bufferSource.start(0,c,86400):f.bufferSource.start(0,c,l),u!==1/0&&(o._endTimers[r._id]=setTimeout(o._ended.bind(o,r),u)),n||setTimeout(function(){o._emit("play",r._id),o._loadQueue()},0)};"running"===w.state?v():(o._playLock=!0,o.once("resume",v),o._clearTimer(r._id))}else{var g=function(){f.currentTime=c,f.muted=r._muted||o._muted||w._muted||f.muted,f.volume=r._volume*w.volume(),f.playbackRate=r._rate;try{var e=f.play();if(e&&"undefined"!=typeof Promise&&(e instanceof Promise||"function"==typeof e.then)?(o._playLock=!0,m(),e.then(function(){o._playLock=!1,f._unlocked=!0,n||(o._emit("play",r._id),o._loadQueue())}).catch(function(){o._playLock=!1,o._emit("playerror",r._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),r._ended=!0,r._paused=!0})):n||(o._playLock=!1,m(),o._emit("play",r._id),o._loadQueue()),f.playbackRate=r._rate,f.paused)return void o._emit("playerror",r._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==t||r._loop?o._endTimers[r._id]=setTimeout(o._ended.bind(o,r),u):(o._endTimers[r._id]=function(){o._ended(r),f.removeEventListener("ended",o._endTimers[r._id],!1)},f.addEventListener("ended",o._endTimers[r._id],!1))}catch(e){o._emit("playerror",r._id,e)}},E=window&&window.ejecta||!f.readyState&&w._navigator.isCocoonJS;if(3<=f.readyState||E)g();else{o._playLock=!0;var y=function(){g(),f.removeEventListener(w._canPlayEvent,y,!1)};f.addEventListener(w._canPlayEvent,y,!1),o._clearTimer(r._id)}}return r._id}o._ended(r)},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var n=t._getSoundIds(e),o=0;o<n.length;o++){t._clearTimer(n[o]);var i=t._soundById(n[o]);if(i&&!i._paused&&(i._seek=t.seek(n[o]),i._rateSeek=0,i._paused=!0,t._stopFade(n[o]),i._node))if(t._webAudio){if(!i._node.bufferSource)continue;void 0===i._node.bufferSource.stop?i._node.bufferSource.noteOff(0):i._node.bufferSource.stop(0),t._cleanBuffer(i._node)}else isNaN(i._node.duration)&&i._node.duration!==1/0||i._node.pause();arguments[1]||t._emit("pause",i?i._id:null)}return t},stop:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"stop",action:function(){n.stop(e)}}),n;for(var o=n._getSoundIds(e),i=0;i<o.length;i++){n._clearTimer(o[i]);var a=n._soundById(o[i]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,n._stopFade(o[i]),a._node&&(n._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),n._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause())),t||n._emit("stop",a._id))}return n},mute:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"mute",action:function(){n.mute(e,t)}}),n;if(void 0===t){if("boolean"!=typeof e)return n._muted;n._muted=e}for(var o=n._getSoundIds(t),i=0;i<o.length;i++){var a=n._soundById(o[i]);a&&(a._muted=e,a._interval&&n._stopFade(a._id),n._webAudio&&a._node?a._node.gain.setValueAtTime(e?0:a._volume,w.ctx.currentTime):a._node&&(a._node.muted=!!w._muted||e),n._emit("mute",a._id))}return n},volume:function(){var e,t,n,o=this,i=arguments;if(0===i.length)return o._volume;if(1===i.length||2===i.length&&void 0===i[1]?0<=o._getSoundIds().indexOf(i[0])?t=parseInt(i[0],10):e=parseFloat(i[0]):2<=i.length&&(e=parseFloat(i[0]),t=parseInt(i[1],10)),!(void 0!==e&&0<=e&&e<=1))return(n=t?o._soundById(t):o._sounds[0])?n._volume:0;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"volume",action:function(){o.volume.apply(o,i)}}),o;void 0===t&&(o._volume=e),t=o._getSoundIds(t);for(var a=0;a<t.length;a++)(n=o._soundById(t[a]))&&(n._volume=e,i[2]||o._stopFade(t[a]),o._webAudio&&n._node&&!n._muted?n._node.gain.setValueAtTime(e,w.ctx.currentTime):n._node&&!n._muted&&(n._node.volume=e*w.volume()),o._emit("volume",n._id));return o},fade:function(e,t,n,o){var i=this;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"fade",action:function(){i.fade(e,t,n,o)}}),i;e=parseFloat(e),t=parseFloat(t),n=parseFloat(n),i.volume(e,o);for(var a=i._getSoundIds(o),r=0;r<a.length;r++){var s=i._soundById(a[r]);if(s){if(o||i._stopFade(a[r]),i._webAudio&&!s._muted){var c=w.ctx.currentTime,l=c+n/1e3;s._volume=e,s._node.gain.setValueAtTime(e,c),s._node.gain.linearRampToValueAtTime(t,l)}i._startFadeInterval(s,e,t,n,a[r],void 0===o)}}return i},_startFadeInterval:function(t,n,o,i,e,a){var r=this,s=n,c=o-n,l=Math.abs(c/.01),u=Math.max(4,0<l?i/l:i),h=Date.now();t._fadeTo=o,t._interval=setInterval(function(){var e=(Date.now()-h)/i;h=Date.now(),s+=c*e,s=Math.max(0,s),s=Math.min(1,s),s=Math.round(100*s)/100,r._webAudio?t._volume=s:r.volume(s,t._id,!0),a&&(r._volume=s),(o<n&&s<=o||n<o&&o<=s)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,r.volume(o,t._id),r._emit("fade",t._id))},u)},_stopFade:function(e){var t=this,n=t._soundById(e);return n&&n._interval&&(t._webAudio&&n._node.gain.cancelScheduledValues(w.ctx.currentTime),clearInterval(n._interval),n._interval=null,t.volume(n._fadeTo,e),n._fadeTo=null,t._emit("fade",e)),t},loop:function(){var e,t,n,o=this,i=arguments;if(0===i.length)return o._loop;if(1===i.length){if("boolean"!=typeof i[0])return!!(n=o._soundById(parseInt(i[0],10)))&&n._loop;e=i[0],o._loop=e}else 2===i.length&&(e=i[0],t=parseInt(i[1],10));for(var a=o._getSoundIds(t),r=0;r<a.length;r++)(n=o._soundById(a[r]))&&(n._loop=e,o._webAudio&&n._node&&n._node.bufferSource&&(n._node.bufferSource.loop=e)&&(n._node.bufferSource.loopStart=n._start||0,n._node.bufferSource.loopEnd=n._stop));return o},rate:function(){var e,t,n,o=this,i=arguments;if(0===i.length)t=o._sounds[0]._id;else if(1===i.length){0<=o._getSoundIds().indexOf(i[0])?t=parseInt(i[0],10):e=parseFloat(i[0])}else 2===i.length&&(e=parseFloat(i[0]),t=parseInt(i[1],10));if("number"!=typeof e)return(n=o._soundById(t))?n._rate:o._rate;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"rate",action:function(){o.rate.apply(o,i)}}),o;void 0===t&&(o._rate=e),t=o._getSoundIds(t);for(var a=0;a<t.length;a++)if(n=o._soundById(t[a])){o.playing(t[a])&&(n._rateSeek=o.seek(t[a]),n._playStart=o._webAudio?w.ctx.currentTime:n._playStart),n._rate=e,o._webAudio&&n._node&&n._node.bufferSource?n._node.bufferSource.playbackRate.setValueAtTime(e,w.ctx.currentTime):n._node&&(n._node.playbackRate=e);var r=o.seek(t[a]),s=1e3*((o._sprite[n._sprite][0]+o._sprite[n._sprite][1])/1e3-r)/Math.abs(n._rate);!o._endTimers[t[a]]&&n._paused||(o._clearTimer(t[a]),o._endTimers[t[a]]=setTimeout(o._ended.bind(o,n),s)),o._emit("rate",n._id)}return o},seek:function(){var e,t,n=this,o=arguments;if(0===o.length)t=n._sounds[0]._id;else if(1===o.length){0<=n._getSoundIds().indexOf(o[0])?t=parseInt(o[0],10):n._sounds.length&&(t=n._sounds[0]._id,e=parseFloat(o[0]))}else 2===o.length&&(e=parseFloat(o[0]),t=parseInt(o[1],10));if(void 0===t)return n;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"seek",action:function(){n.seek.apply(n,o)}}),n;var i=n._soundById(t);if(i){if(!("number"==typeof e&&0<=e)){if(n._webAudio){var a=n.playing(t)?w.ctx.currentTime-i._playStart:0,r=i._rateSeek?i._rateSeek-i._seek:0;return i._seek+(r+a*Math.abs(i._rate))}return i._node.currentTime}var s=n.playing(t);s&&n.pause(t,!0),i._seek=e,i._ended=!1,n._clearTimer(t),n._webAudio||!i._node||isNaN(i._node.duration)||(i._node.currentTime=e);var c=function(){n._emit("seek",t),s&&n.play(t,!0)};if(s&&!n._webAudio){var l=function(){n._playLock?setTimeout(l,0):c()};setTimeout(l,0)}else c()}return n},playing:function(e){if("number"==typeof e){var t=this._soundById(e);return!!t&&!t._paused}for(var n=0;n<this._sounds.length;n++)if(!this._sounds[n]._paused)return!0;return!1},duration:function(e){var t=this._duration,n=this._soundById(e);return n&&(t=this._sprite[n._sprite][1]/1e3),t},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,n=0;n<t.length;n++){if(t[n]._paused||e.stop(t[n]._id),!e._webAudio)/MSIE |Trident\//.test(w._navigator&&w._navigator.userAgent)||(t[n]._node.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"),t[n]._node.removeEventListener("error",t[n]._errorFn,!1),t[n]._node.removeEventListener(w._canPlayEvent,t[n]._loadFn,!1),w._releaseHtml5Audio(t[n]._node);delete t[n]._node,e._clearTimer(t[n]._id)}var o=w._howls.indexOf(e);0<=o&&w._howls.splice(o,1);var i=!0;for(n=0;n<w._howls.length;n++)if(w._howls[n]._src===e._src||0<=e._src.indexOf(w._howls[n]._src)){i=!1;break}return r&&i&&delete r[e._src],w.noAudio=!1,e._state="unloaded",e._sounds=[],e=null},on:function(e,t,n,o){var i=this["_on"+e];return"function"==typeof t&&i.push(o?{id:n,fn:t,once:o}:{id:n,fn:t}),this},off:function(e,t,n){var o=this,i=o["_on"+e],a=0;if("number"==typeof t&&(n=t,t=null),t||n)for(a=0;a<i.length;a++){var r=n===i[a].id;if(t===i[a].fn&&r||!t&&r){i.splice(a,1);break}}else if(e)o["_on"+e]=[];else{var s=Object.keys(o);for(a=0;a<s.length;a++)0===s[a].indexOf("_on")&&Array.isArray(o[s[a]])&&(o[s[a]]=[])}return o},once:function(e,t,n){return this.on(e,t,n,1),this},_emit:function(e,t,n){for(var o=this,i=o["_on"+e],a=i.length-1;0<=a;a--)i[a].id&&i[a].id!==t&&"load"!==e||(setTimeout(function(e){e.call(this,t,n)}.bind(o,i[a].fn),0),i[a].once&&o.off(e,i[a].fn,i[a].id));return o._loadQueue(e),o},_loadQueue:function(e){var t=this;if(0<t._queue.length){var n=t._queue[0];n.event===e&&(t._queue.shift(),t._loadQueue()),e||n.action()}return t},_ended:function(e){var t=this,n=e._sprite;if(!t._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(t._ended.bind(t,e),100),t;var o=!(!e._loop&&!t._sprite[n][2]);if(t._emit("end",e._id),!t._webAudio&&o&&t.stop(e._id,!0).play(e._id),t._webAudio&&o){t._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=w.ctx.currentTime;var i=1e3*(e._stop-e._start)/Math.abs(e._rate);t._endTimers[e._id]=setTimeout(t._ended.bind(t,e),i)}return t._webAudio&&!o&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,t._clearTimer(e._id),t._cleanBuffer(e._node),w._autoSuspend()),t._webAudio||o||t.stop(e._id,!0),t},_clearTimer:function(e){var t=this;if(t._endTimers[e]){if("function"!=typeof t._endTimers[e])clearTimeout(t._endTimers[e]);else{var n=t._soundById(e);n&&n._node&&n._node.removeEventListener("ended",t._endTimers[e],!1)}delete t._endTimers[e]}return t},_soundById:function(e){for(var t=0;t<this._sounds.length;t++)if(e===this._sounds[t]._id)return this._sounds[t];return null},_inactiveSound:function(){var e=this;e._drain();for(var t=0;t<e._sounds.length;t++)if(e._sounds[t]._ended)return e._sounds[t].reset();return new a(e)},_drain:function(){var e=this,t=e._pool,n=0,o=0;if(!(e._sounds.length<t)){for(o=0;o<e._sounds.length;o++)e._sounds[o]._ended&&n++;for(o=e._sounds.length-1;0<=o;o--){if(n<=t)return;e._sounds[o]._ended&&(e._webAudio&&e._sounds[o]._node&&e._sounds[o]._node.disconnect(0),e._sounds.splice(o,1),n--)}}},_getSoundIds:function(e){if(void 0!==e)return[e];for(var t=[],n=0;n<this._sounds.length;n++)t.push(this._sounds[n]._id);return t},_refreshBuffer:function(e){return e._node.bufferSource=w.ctx.createBufferSource(),e._node.bufferSource.buffer=r[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,w.ctx.currentTime),this},_cleanBuffer:function(e){var t=w._navigator&&0<=w._navigator.vendor.indexOf("Apple");if(w._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=w._scratchBuffer}catch(e){}return e.bufferSource=null,this}};var a=function(e){this._parent=e,this.init()};a.prototype={init:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++w._counter,t._sounds.push(e),e.create(),e},create:function(){var e=this,t=e._parent,n=w._muted||e._muted||e._parent._muted?0:e._volume;return t._webAudio?(e._node=void 0===w.ctx.createGain?w.ctx.createGainNode():w.ctx.createGain(),e._node.gain.setValueAtTime(n,w.ctx.currentTime),e._node.paused=!0,e._node.connect(w.masterGain)):(e._node=w._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(w._canPlayEvent,e._loadFn,!1),e._node.src=t._src,e._node.preload="auto",e._node.volume=n*w.volume(),e._node.load()),e},reset:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++w._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this._parent;e._duration=Math.ceil(10*this._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),this._node.removeEventListener(w._canPlayEvent,this._loadFn,!1)}};var r={},s=function(t){var e=t._src;if(r[e])return t._duration=r[e].duration,void u(t);if(/^data:[^;]+;base64,/.test(e)){for(var n=atob(e.split(",")[1]),o=new Uint8Array(n.length),i=0;i<n.length;++i)o[i]=n.charCodeAt(i);l(o.buffer,t)}else{var a=new XMLHttpRequest;a.open("GET",e,!0),a.withCredentials=t._xhrWithCredentials,a.responseType="arraybuffer",a.onload=function(){var e=(a.status+"")[0];"0"===e||"2"===e||"3"===e?l(a.response,t):t._emit("loaderror",null,"Failed loading audio file with status: "+a.status+".")},a.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete r[e],t.load())},c(a)}},c=function(t){try{t.send()}catch(e){t.onerror()}},l=function(e,t){var n=function(){t._emit("loaderror",null,"Decoding audio data failed.")},o=function(e){e&&0<t._sounds.length?(r[t._src]=e,u(t,e)):n()};"undefined"!=typeof Promise&&1===w.ctx.decodeAudioData.length?w.ctx.decodeAudioData(e).then(o).catch(n):w.ctx.decodeAudioData(e,o,n)},u=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},h=function(){if(w.usingWebAudio){try{"undefined"!=typeof AudioContext?w.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?w.ctx=new webkitAudioContext:w.usingWebAudio=!1}catch(e){w.usingWebAudio=!1}w.ctx||(w.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(w._navigator&&w._navigator.platform),t=w._navigator&&w._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),n=t?parseInt(t[1],10):null;if(e&&n&&n<9){var o=/safari/.test(w._navigator&&w._navigator.userAgent.toLowerCase());(w._navigator&&w._navigator.standalone&&!o||w._navigator&&!w._navigator.standalone&&!o)&&(w.usingWebAudio=!1)}w.usingWebAudio&&(w.masterGain=void 0===w.ctx.createGain?w.ctx.createGainNode():w.ctx.createGain(),w.masterGain.gain.setValueAtTime(w._muted?0:1,w.ctx.currentTime),w.masterGain.connect(w.ctx.destination)),w._setup()}};return{Howler:w,Howl:t}}(),TWEEN=(fe=[],{getAll:function(){return fe},removeAll:function(){fe=[]},add:function(e){fe.push(e)},remove:function(e){var t=fe.indexOf(e);-1!==t&&fe.splice(t,1)},update:function(e,t){if(0===fe.length)return!1;var n=0;for(e=void 0!==e?e:TWEEN.now();n<fe.length;)fe[n].update(e)||t?n++:fe.splice(n,1);return!0}}),fe,qg;"undefined"==typeof window&&"undefined"!=typeof process?TWEEN.now=function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?TWEEN.now=window.performance.now.bind(window.performance):void 0!==Date.now?TWEEN.now=Date.now:TWEEN.now=function(){return(new Date).getTime()},TWEEN.Tween=function(e){var l,u=e,h={},d={},p={},m=1e3,f=0,v=!1,n=!1,g=!1,E=0,y=null,o=!1,t=null,w=TWEEN.Easing.Linear.None,b=TWEEN.Interpolation.Linear,T=[],_=null,R=!1,x=null,S=null,i=null;this.isPlaying=function(){return n},this.isPaused=function(){return o},this.to=function(e,t){return d=e,void 0!==t&&(m=t),this},this.start=function(e){for(var t in TWEEN.add(this),R=o=!(n=!0),y=void 0!==e?e:TWEEN.now(),y+=E,d){if(d[t]instanceof Array){if(0===d[t].length)continue;d[t]=[u[t]].concat(d[t])}void 0!==u[t]&&(h[t]=u[t],h[t]instanceof Array==!1&&(h[t]*=1),p[t]=h[t]||0)}return this},this.stop=function(){return n&&(TWEEN.remove(this),o=n=!1,null!==i&&i.call(u,u),this.stopChainedTweens()),this},this.end=function(){return this.update(y+m),this},this.stopChainedTweens=function(){for(var e=0,t=T.length;e<t;e++)T[e].stop()},this.delay=function(e){return E=e,this},this.pause=function(){o||(o=!0,t=(new Date).getTime(),TWEEN.remove(this))},this.play=function(){if(o){o=!1;var e=(new Date).getTime();y+=e-t,TWEEN.add(this)}},this.repeat=function(e){return f=e,this},this.repeatDelay=function(e){return l=e,this},this.yoyo=function(e){return v=e,this},this.easing=function(e){return w=e,this},this.interpolation=function(e){return b=e,this},this.chain=function(){return T=arguments,this},this.onStart=function(e){return _=e,this},this.onUpdate=function(e){return x=e,this},this.onComplete=function(e){return S=e,this},this.onStop=function(e){return i=e,this},this.update=function(e){var t,n,o;if(e<y)return!0;for(t in!1===R&&(null!==_&&_.call(u,u),R=!0),o=w(n=1<(n=(e-y)/m)?1:n),d)if(void 0!==h[t]){var i=h[t]||0,a=d[t];a instanceof Array?u[t]=b(a,o):("string"==typeof a&&(a="+"===a.charAt(0)||"-"===a.charAt(0)?i+parseFloat(a):parseFloat(a)),"number"==typeof a&&(u[t]=i+(a-i)*o))}if(null!==x&&x.call(u,o),1!==n)return!0;if(0<f){for(t in isFinite(f)&&f--,p){if("string"==typeof d[t]&&(p[t]=p[t]+parseFloat(d[t])),v){var r=p[t];p[t]=d[t],d[t]=r}h[t]=p[t]}return v&&(g=!g),y=void 0!==l?e+l:e+E,!0}null!==S&&S.call(u,u);for(var s=0,c=T.length;s<c;s++)T[s].start(y+m);return!1}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var n=e.length-1,o=n*t,i=Math.floor(o),a=TWEEN.Interpolation.Utils.Linear;return t<0?a(e[0],e[1],o):1<t?a(e[n],e[n-1],n-o):a(e[i],e[n<i+1?n:i+1],o-i)},Bezier:function(e,t){for(var n=0,o=e.length-1,i=Math.pow,a=TWEEN.Interpolation.Utils.Bernstein,r=0;r<=o;r++)n+=i(1-t,o-r)*i(t,r)*e[r]*a(o,r);return n},CatmullRom:function(e,t){var n=e.length-1,o=n*t,i=Math.floor(o),a=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(i=Math.floor(o=n*(1+t))),a(e[(i-1+n)%n],e[i],e[(i+1)%n],e[(i+2)%n],o-i)):t<0?e[0]-(a(e[0],e[0],e[1],e[1],-o)-e[0]):1<t?e[n]-(a(e[n],e[n],e[n-1],e[n-1],o-n)-e[n]):a(e[i?i-1:0],e[i],e[n<i+1?n:i+1],e[n<i+2?n:i+2],o-i)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=TWEEN.Interpolation.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:(qg=[1],function(e){var t=1;if(qg[e])return qg[e];for(var n=e;1<n;n--)t*=n;return qg[e]=t}),CatmullRom:function(e,t,n,o,i){var a=.5*(n-e),r=.5*(o-t),s=i*i;return(2*t-2*n+a+r)*(i*s)+(-3*t+3*n-2*a-r)*s+a*i+t}}};var $=function(){var doc=document,win=window,div=doc.createElement("div"),_a=Array.prototype,filter=_a.filter,indexOf=_a.indexOf,map=_a.map,push=_a.push,reverse=_a.reverse,slice=_a.slice,some=_a.some,splice=_a.splice,idRe=/^#[\w-]*$/,classRe=/^\.[\w-]*$/,htmlRe=/<.+>/,tagRe=/^\w+$/;function find(e,t){return void 0===t&&(t=doc),t!==doc&&1!==t.nodeType&&9!==t.nodeType?[]:classRe.test(e)?t.getElementsByClassName(e.slice(1)):tagRe.test(e)?t.getElementsByTagName(e):t.querySelectorAll(e)}var Cash=function(){function n(e,t){if(void 0===t&&(t=doc),e){if(isCash(e))return e;var n=e;if(isString(e)){var o=isCash(t)?t[0]:t;if(!(n=idRe.test(e)?o.getElementById(e.slice(1)):htmlRe.test(e)?parseHTML(e):find(e,o)))return}else if(isFunction(e))return this.ready(e);(n.nodeType||n===win)&&(n=[n]),this.length=n.length;for(var i=0,a=this.length;i<a;i++)this[i]=n[i]}}return n.prototype.init=function(e,t){return new n(e,t)},n}(),cash=Cash.prototype.init;function attr(n,o){if(n){if(isString(n)){if(arguments.length<2){if(!this[0])return;var e=this[0].getAttribute(n);return null===e?void 0:e}return void 0===o?this:null===o?this.removeAttr(n):this.each(function(e,t){t.setAttribute(n,o)})}for(var t in n)this.attr(t,n[t]);return this}}function getData(e,t){var n=e.dataset?e.dataset[t]||e.dataset[camelCase(t)]:e.getAttribute("data-"+t);try{return JSON.parse(n)}catch(e){}return n}function setData(e,t,n){try{n=JSON.stringify(n)}catch(e){}e.dataset?e.dataset[camelCase(t)]=n:e.setAttribute("data-"+t,n)}cash.fn=cash.prototype=Cash.prototype,Cash.prototype.length=0,Cash.prototype.splice=splice,"function"==typeof Symbol&&(Cash.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator]),Cash.prototype.get=function(e){return void 0===e?slice.call(this):this[e<0?e+this.length:e]},Cash.prototype.add=function(e,t){return cash(unique(this.get().concat(cash(e,t).get())))},Cash.prototype.filter=function(e){if(!e)return cash();var n=getCompareFunction(e);return cash(filter.call(this,function(e,t){return n.call(e,t,e)}))},Cash.prototype.find=function(e){for(var t=[],n=0,o=this.length;n<o;n++){var i=find(e,this[n]);i.length&&push.apply(t,i)}return cash(unique(t))},Cash.prototype.each=function(e){return each(this,e),this},Cash.prototype.append=function(){var n=this;return each(arguments,function(e,t){insertContent(n,cash(t))}),this},Cash.prototype.appendTo=function(e){return insertContent(cash(e),this),this},Cash.prototype.insertAfter=function(e){var t=this;return cash(e).each(function(n,o){var i=o.parentNode;i&&t.each(function(e,t){insertElement(i,n?t.cloneNode(!0):t,!0,o.nextSibling)})}),this},Cash.prototype.after=function(){var n=this;return each(reverse.apply(arguments),function(e,t){reverse.apply(cash(t).slice()).insertAfter(n)}),this},Cash.prototype.insertBefore=function(e){var t=this;return cash(e).each(function(n,o){var i=o.parentNode;i&&t.each(function(e,t){insertElement(i,n?t.cloneNode(!0):t,!0,o)})}),this},Cash.prototype.before=function(){var n=this;return each(arguments,function(e,t){cash(t).insertBefore(n)}),this},Cash.prototype.prepend=function(){var n=this;return each(arguments,function(e,t){insertContent(n,cash(t),!0)}),this},Cash.prototype.prependTo=function(e){return insertContent(cash(e),reverse.apply(this.slice()),!0),this},Cash.prototype.toggleClass=function(e,o){var t=getSplitValues(e),i=void 0!==o;return t.length?this.each(function(e,n){each(t,function(e,t){i?o?n.classList.add(t):n.classList.remove(t):n.classList.toggle(t)})}):this},Cash.prototype.addClass=function(e){return this.toggleClass(e,!0)},Cash.prototype.removeClass=function(e){return arguments.length?this.toggleClass(e,!1):this.attr("class","")},Cash.prototype.hasClass=function(t){return t&&some.call(this,function(e){return e.classList.contains(t)})},Cash.prototype.removeAttr=function(e){var t=getSplitValues(e);return t.length?this.each(function(e,n){each(t,function(e,t){n.removeAttribute(t)})}):this},Cash.prototype.attr=attr;var dataAttributeRe=/^data-(.+)/;function data(n,o){var i=this;if(!n){if(!this[0])return;var a={};return each(this[0].attributes,function(e,t){var n=t.name.match(dataAttributeRe);n&&(a[n[1]]=i.data(n[1]))}),a}if(isString(n))return void 0===o?this[0]&&getData(this[0],n):this.each(function(e,t){return setData(t,n,o)});for(var e in n)this.data(e,n[e]);return this}function html(n){return void 0===n?this[0]&&this[0].innerHTML:this.each(function(e,t){t.innerHTML=n})}function getCompareFunction(n){return isString(n)?function(e,t){return matches(t,n)}:isFunction(n)?n:isCash(n)?function(e,t){return n.is(t)}:function(e,t){return t===n}}Cash.prototype.data=data,Cash.prototype.trigger=function(e,t){var n=e;if(isString(e)){var o=parseEventName(e),i=o[0],a=o[1],r=eventsMouseRe.test(i)?"MouseEvents":"HTMLEvents";(n=doc.createEvent(r)).initEvent(i,!0,!0),n.namespace=a.join(eventsNamespacesSeparator)}n.data=t;var s=n.type in eventsFocus;return this.each(function(e,t){s&&isFunction(t[n.type])?t[n.type]():t.dispatchEvent(n)})},Cash.prototype.on=function(e,c,l,u){var o=this;if(isString(e))return isFunction(c)&&(l=c,c=""),each(getSplitValues(e),function(e,t){var n=parseEventName(getEventNameBubbling(t)),r=n[0],s=n[1];o.each(function(e,a){var t=function e(t){if(!t.namespace||hasNamespaces(s,t.namespace.split(eventsNamespacesSeparator))){var n=a;if(c){for(var o=t.target;!matches(o,c);){if(o===a)return;if(!(o=o.parentNode))return}n=o,t.__delegate=!0}t.__delegate&&Object.defineProperty(t,"currentTarget",{configurable:!0,get:function(){return n}});var i=l.call(n,t,t.data);u&&removeEvent(a,r,s,e),!1===i&&(t.preventDefault(),t.stopPropagation())}};t.guid=l.guid=l.guid||guid++,addEvent(a,r,s,t)})}),this;for(var t in e)this.on(t,c,e[t]);return this},Cash.prototype.off=function(e,a){var r=this;return void 0===e?this.each(function(e,t){return removeEvent(t)}):each(getSplitValues(e),function(e,t){var n=parseEventName(getEventNameBubbling(t)),o=n[0],i=n[1];r.each(function(e,t){return removeEvent(t,o,i,a)})}),this},Cash.prototype.detach=function(){return this.each(function(e,t){t.parentNode&&t.parentNode.removeChild(t)})},Cash.prototype.html=html,Cash.prototype.remove=function(){return this.detach().off()},Cash.prototype.css=function(n,o){if(isString(n)){var i=isCSSVariable(n);return n=getPrefixedProp(n,i),arguments.length<2?this[0]&&computeStyle(this[0],n,i):n?(o=getSuffixedValue(n,o,i),this.each(function(e,t){1===t.nodeType&&(i?t.style.setProperty(n,o):t.style[n]=o)})):this}for(var e in n)this.css(e,n[e]);return this};var scriptTypeRe=/^$|^module$|\/(?:java|ecma)script/i,HTMLCDATARe=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function evalScripts(node){var collection=cash(node);collection.filter("script").add(collection.find("script")).each(function(i,ele){!ele.src&&scriptTypeRe.test(ele.type)&&ele.ownerDocument.documentElement.contains(ele)&&eval(ele.textContent.replace(HTMLCDATARe,""))})}function insertElement(e,t,n,o){n?e.insertBefore(t,o):e.appendChild(t),evalScripts(t)}function insertContent(e,t,i){each(e,function(n,o){each(t,function(e,t){insertElement(o,n?t.cloneNode(!0):t,i,i&&o.firstChild)})})}function isCash(e){return e instanceof Cash}function isFunction(e){return"function"==typeof e}function isString(e){return"string"==typeof e}function isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}function each(e,t){for(var n=0,o=e.length;n<o&&!1!==t.call(e[n],n,e[n]);n++);}function matches(e,t){var n=e&&(e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector||e.oMatchesSelector);return!!n&&n.call(e,t)}function unique(e){return 1<e.length?filter.call(e,function(e,t,n){return indexOf.call(n,e)===t}):e}var fragmentRe=/^\s*<(\w+)[^>]*>/,singleTagRe=/^\s*<(\w+)\s*\/?>(?:<\/\1>)?\s*$/,containers;function initContainers(){if(!containers){var e=doc.createElement("table"),t=doc.createElement("tr");containers={"*":div,tr:doc.createElement("tbody"),td:t,th:t,thead:e,tbody:e,tfoot:e}}}function parseHTML(e){if(initContainers(),!isString(e))return[];if(singleTagRe.test(e))return[doc.createElement(RegExp.$1)];var t=fragmentRe.test(e)&&RegExp.$1,n=containers[t]||containers["*"];return n.innerHTML=e,cash(n.childNodes).detach().get()}var splitValuesRe=/\S+/g;function getSplitValues(e){return isString(e)&&e.match(splitValuesRe)||[]}function parseEventName(e){var t=e.split(eventsNamespacesSeparator);return[t[0],t.slice(1).sort()]}function hasNamespaces(t,e){return!e||!some.call(e,function(e){return t.indexOf(e)<0})}var eventsNamespace="__cashEvents",eventsNamespacesSeparator=".",eventsFocus={focus:"focusin",blur:"focusout"},eventsHover={mouseenter:"mouseover",mouseleave:"mouseout"},eventsMouseRe=/^(?:mouse|pointer|contextmenu|drag|drop|click|dblclick)/i;function getEventNameBubbling(e){return eventsHover[e]||eventsFocus[e]||e}var guid=1;function getEventsCache(e){return e[eventsNamespace]=e[eventsNamespace]||{}}function addEvent(e,t,n,o){o.guid=o.guid||guid++;var i=getEventsCache(e);i[t]=i[t]||[],i[t].push([n,o]),e.addEventListener(t,o)}function removeEvent(o,i,a,r){var e=getEventsCache(o);if(i)e[i]&&(e[i]=e[i].filter(function(e){var t=e[0],n=e[1];if(r&&n.guid!==r.guid||!hasNamespaces(t,a))return!0;o.removeEventListener(i,n)}));else{for(i in e)removeEvent(o,i,a,r);delete o[eventsNamespace]}}var cssVariableRe=/^--/;function isCSSVariable(e){return cssVariableRe.test(e)}var prefixedProps={},style=div.style,vendorsPrefixes=["webkit","moz","ms","o"];function getPrefixedProp(n,e){if(void 0===e&&(e=isCSSVariable(n)),e)return n;if(!prefixedProps[n]){var t=camelCase(n),o=""+t.charAt(0).toUpperCase()+t.slice(1);each((t+" "+vendorsPrefixes.join(o+" ")+o).split(" "),function(e,t){if(t in style)return prefixedProps[n]=t,!1})}return prefixedProps[n]}var dashAlphaRe=/-([a-z])/g;function camelCaseReplace(e,t){return t.toUpperCase()}function camelCase(e){return e.replace(dashAlphaRe,camelCaseReplace)}var numericProps={animationIterationCount:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0};function getSuffixedValue(e,t,n){return void 0===n&&(n=isCSSVariable(e)),n||numericProps[e]||!isNumeric(t)?t:t+"px"}var Deferred=function(){arguments[0];var t="pending",n=[],o=[],i=[],a=[],r=[],s=[],c=!1,l=function(){var e=Array.prototype.slice.call(arguments);return n=n.concat(e),"resolved"==t&&d.call(this,e,a,{sameArgument:!0}),this},u=function(){var e=Array.prototype.slice.call(arguments);return o=o.concat(e),"rejected"==t&&d.call(this,e,r,{sameArgument:!0}),this},h=function(){var e=Array.prototype.slice.call(arguments);return i=i.concat(e),"pending"==t&&c&&d.call(this,e,s,{sameArgument:!0}),this},d=function(n,o,e){var t,i=(e=e||{}).scope||this;for(var a in t=e.sameArgument?function(e,t){"function"==typeof e&&e.apply(i,o)}:function(e,t){"function"==typeof e&&e.apply(i,n[t])},n)t(n[a],a)};this.resolve=function(){return function(){return"pending"==t&&(a=arguments,d.call(this,n,a,{sameArgument:!0}),t="resolved"),this}.apply(this,arguments)},this.reject=function(){return function(){return"pending"==t&&(r=arguments,d.call(this,o,r,{sameArgument:!0}),t="rejected"),this}.apply(this,arguments)},this.notify=function(){return function(){return"pending"==t&&(s=arguments,d.call(this,i,s,{sameArgument:!0}),c=!0),this}.apply(this,arguments)},this.done=function(){return l.apply(this,arguments)},this.fail=function(){return u.apply(this,arguments)},this.progress=function(){return h.apply(this,arguments)},this.always=function(){return function(){var e=Array.prototype.slice.call(arguments);return n=n.concat(e),o=o.concat(e),"pending"!=t&&d.call(this,e,a||r,{sameArgument:!0}),this}.apply(this,arguments)},this.then=function(){return function(){var e=[];for(var t in arguments){var n=void 0;n=Array.isArray(arguments[t])?arguments[t]:[arguments[t]],e.push(n)}return l.apply(this,e[0]),u.apply(this,e[1]),h.apply(this,e[2]),this}.apply(this,arguments)},this.promise=function(){return function(){var e=["resolve","reject","promise","notify"],t={};for(var n in this)-1==e.indexOf(n)&&(t[n]=this[n]);return t}.apply(this,arguments)},this.state=function(){return function(){return 0<arguments.length&&(t=arguments[0]),t}.apply(this)}},isArray=Array.isArray;return cash.isArray=isArray,cash.Deferred=Deferred,cash}(),SmartRequest=function(){this.requests=[];var t=this;this.push=function(e){t.requests.push(e)},this.abort=function(){for(var e=0;e<t.requests.length;e++)t.requests[e].abort();t.requests=[]}},Utils={checkTouch:function(){return!!window&&("ontouchstart"in window||window.navigator.msMaxTouchPoints)},checkMobile:function(){return/Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},checkWebgl:function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}},extend:function(e,t){for(var n in t||(t={}),e)e.hasOwnProperty(n)&&!t.hasOwnProperty(n)&&(t[n]=e[n]);return t},ImageLoader:{load:function(t,e,n,o,i){if(!t)return console.warn("IPANORAMA.Utils.ImageLoader: image source undefined"),void(o&&o());var a,r,s,c,l,u;if(void 0===(a=THREE.Cache.get(t))){if(l=window.URL||window.webkitURL,u=document.createElementNS("http://www.w3.org/1999/xhtml","img"),0===t.indexOf("data:"))return u.addEventListener("load",h,!1),u.src=t,u;u.crossOrigin=void 0!==this.crossOrigin?this.crossOrigin:"",r=new XMLHttpRequest,i&&i.push(r);try{r.open("GET",t,!0),r.responseType="arraybuffer",r.onprogress=function(e){e.lengthComputable&&n&&n({loaded:e.loaded,total:e.total})},r.onload=function(e){200==r.status?(THREE.Cache.add(t,u),s=new Uint8Array(this.response),c=new Blob([s]),u.addEventListener("load",h,!1),u.src=l.createObjectURL(c)):o&&o()},r.onloadend=function(e){200!=r.status&&0!==r.status&&o&&o()},r.send(null)}catch(e){console.warn("IPANORAMA.Utils.ImageLoader: image loading error"),o&&o()}}else e&&setTimeout(function(){n&&n({loaded:1,total:1}),e(a)},0);function h(){l.revokeObjectURL(u.src),e&&e(u)}}},TextureLoader:{load:function(e,r,t,n,o,s){Utils.ImageLoader.load(e,function(e){var t=new THREE.Texture;if(t.imageOriginalSize={width:e.width,height:e.height},s&&(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height))){var n=THREE.Math.ceilPowerOfTwo(e.width),o=THREE.Math.ceilPowerOfTwo(e.height),i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");i.width=n,i.height=o;var a=i.getContext("2d");a.drawImage(e,0,0,e.width,e.height),a.drawImage(e,e.width-1,0,1,e.height,e.width,0,n-e.width,e.height),e=i}t.image=e,t.needsUpdate=!0,r&&r(t)},t,n,o)}},CubeOneTextureLoader:{load:function(e,s,t,n,o){Utils.ImageLoader.load(e,function(e){var t=new THREE.CubeTexture([]);t.images=new Array(6);for(var n=0;n<6;n++){var o=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=o.getContext("2d"),a=e.width/6,r=e.height;switch(o.width=a,o.height=r,4!=n&&5!=n||(i.translate(a/2,r/2),i.rotate((4==n?-90:90)*Math.PI/180),i.translate(-a/2,-r/2)),i.drawImage(e,a*n,0,a,r,0,0,a,r),n){case 0:t.images[0]=o;break;case 1:t.images[5]=o;break;case 2:t.images[1]=o;break;case 3:t.images[4]=o;break;case 4:t.images[2]=o;break;case 5:t.images[3]=o}}t.needsUpdate=!0,s&&s(t)},t,n,o)}},CubeSixTextureLoader:{load:function(e,r,n,t,o){var s,c,i,l,u,h;function a(e,a){Utils.ImageLoader.load(e,function(e){var t,n;if(4==a||5==a){n=(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")).getContext("2d");var o=e.width,i=e.height;t.width=o,t.height=i,n.translate(o/2,i/2),n.rotate((4==a?-90:90)*Math.PI/180),n.translate(-o/2,-i/2),n.drawImage(e,0,0,o,i,0,0,o,i)}switch(a){case 0:s.images[0]=e;break;case 1:s.images[1]=e;break;case 2:s.images[4]=e;break;case 3:s.images[5]=e;break;case 4:s.images[2]=t;break;case 5:s.images[3]=t}6===++c&&(s.needsUpdate=!0,r&&r(s))},function(e){for(var t in l[a]={loaded:e.loaded,total:e.total},u.loaded=0,u.total=0,h=0,l)h++,u.loaded+=l[t].loaded,u.total+=l[t].total;h<6&&(u.total=u.total/h*6),n&&n(u)},function(){i=!0,t&&t()},o)}s=new THREE.CubeTexture([]),i=!1,l={},u={};for(var d=c=0;d<e.length;d++)if(a(e[d],d),i)return void(s&&s.dispose())}},Matrix:function(){this.reset()}};Utils.Matrix.prototype={reset:function(){return this.m=[1,0,0,1,0,0],this},multiply:function(e){var t=this.m[0]*e.m[0]+this.m[2]*e.m[1],n=this.m[1]*e.m[0]+this.m[3]*e.m[1],o=this.m[0]*e.m[2]+this.m[2]*e.m[3],i=this.m[1]*e.m[2]+this.m[3]*e.m[3],a=this.m[0]*e.m[4]+this.m[2]*e.m[5]+this.m[4],r=this.m[1]*e.m[4]+this.m[3]*e.m[5]+this.m[5];return this.m[0]=t,this.m[1]=n,this.m[2]=o,this.m[3]=i,this.m[4]=a,this.m[5]=r,this},inverse:function(){var e=new Utils.Matrix;e.m=this.m.slice(0);var t=1/(e.m[0]*e.m[3]-e.m[1]*e.m[2]),n=e.m[3]*t,o=-e.m[1]*t,i=-e.m[2]*t,a=e.m[0]*t,r=t*(e.m[2]*e.m[5]-e.m[3]*e.m[4]),s=t*(e.m[1]*e.m[4]-e.m[0]*e.m[5]);return e.m[0]=n,e.m[1]=o,e.m[2]=i,e.m[3]=a,e.m[4]=r,e.m[5]=s,e},rotate:function(e){var t=Math.cos(e),n=Math.sin(e),o=this.m[0]*t+this.m[2]*n,i=this.m[1]*t+this.m[3]*n,a=this.m[0]*-n+this.m[2]*t,r=this.m[1]*-n+this.m[3]*t;return this.m[0]=o,this.m[1]=i,this.m[2]=a,this.m[3]=r,this},translate:function(e,t){return this.m[4]+=this.m[0]*e+this.m[2]*t,this.m[5]+=this.m[1]*e+this.m[3]*t,this},scale:function(e,t){return this.m[0]*=e,this.m[1]*=e,this.m[2]*=t,this.m[3]*=t,this},transformPoint:function(e,t){var n=e,o=t;return[e=n*this.m[0]+o*this.m[2]+this.m[4],t=n*this.m[1]+o*this.m[3]+this.m[5]]},transformVector:function(e,t){var n=e,o=t;return[e=n*this.m[0]+o*this.m[2],t=n*this.m[1]+o*this.m[3]]},copy:function(){(new Matrix).m=this.m.slice(0)}};var GSVPANO=GSVPANO||{};GSVPANO.PanoLoader=function(e){var r,s,c=e||{},t=new google.maps.StreetViewService,l=0,u=0,a=[],h=[],d=0,p=0,m=[1,2,4,7,13,26],f=[1,1,2,4,7,13],v=[416,832,1664,3328,6656,13312],g=[416,416,832,1664,3328,6656],n=null;try{var o=document.createElement("canvas");null==(n=o.getContext("experimental-webgl"))&&(n=o.getContext("webgl"))}catch(e){}var E=1024,y=1024;if(n){var i=Math.max(n.getParameter(n.MAX_TEXTURE_SIZE),6656);E=y=i}this.setProgress=function(e,t){this.onProgress&&this.onProgress({loaded:e,total:t})},this.throwError=function(e){this.onError?this.onError(e):console.error(e)},this.adaptTextureToZoom=function(){var e,t;e=v[r],t=g[r],d=Math.ceil(e/E),p=Math.ceil(t/y),a=[],h=[];for(var n=0;n<p;n++)for(var o=0;o<d;o++){var i=document.createElement("canvas");i.width=o<d-1?E:e-E*o,i.height=n<p-1?y:t-y*n,a.push(i),h.push(i.getContext("2d")),0}},this.composeFromTile=function(e,t,n){e*=512,t*=512;var o=Math.floor(e/E),i=Math.floor(t/y);e-=o*E,t-=i*y,h[i*d+o].drawImage(n,0,0,n.width,n.height,e,t,512,512),this.progress()},this.progress=function(){l++;Math.round(100*l/u);this.setProgress(l,u),l===u&&(this.canvas=a,this.panoId=s,this.zoom=r,this.onPanoramaLoad&&this.onPanoramaLoad(a[0]))},this.composePanorama=function(){this.setProgress(0,1);var e=m[r],t=f[r];u=e*t;for(var i=this,n=l=0;n<t;n++)for(var o=0;o<e;o++){var a="https://geo0.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&output=tile&zoom="+r+"&x="+o+"&y="+n+"&panoid="+s+"&nbt&fover=2";!function(e,t){if(c.useWebGL)var n=THREE.ImageUtils.loadTexture(a,null,function(){i.composeFromTile(e,t,n)});else{var o=new Image;o.addEventListener("load",function(){i.composeFromTile(e,t,this)}),o.crossOrigin="",o.src=a}}(o,n)}};var w=function(e,t){t===google.maps.StreetViewStatus.OK?(this.result=e,this.onPanoramaData&&this.onPanoramaData(e),e.copyright,this.copyright=e.copyright,s=e.location.pano,this.location=location,this.rotation=0,this.composePanorama()):(this.onNoPanoramaData&&this.onNoPanoramaData(t),this.throwError("Could not retrieve panorama for the following reason: "+t))};this.loadById=function(e){t.getPanoramaById(e,w.bind(this))},this.loadByLocation=function(e){t.getPanoramaByLocation(e,50,w.bind(this))},this.setZoom=function(e){r=e,this.adaptTextureToZoom()},this.setZoom(c.zoom||1)};var OrbitControls=function(e,r,s){this.camera=r,this.canvas=void 0!==e?e:document,this.scene=s,(this.scene.control=this).enabled=!0,this.target=new THREE.Vector3,this.noZoom=!1,this.zoomSpeed=1,this.minZoom=0,this.maxZoom=1/0,this.noDolly=!0,this.minDistance=1,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=-.15,this.noPan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeedX=2,this.autoRotateSpeedY=0,this.autoRotateSpeedZ=0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.momentumDampingFactor=.9,this.momentumScalingFactor=-.005,this.momentumKeydownFactor=20,this.minFov=10,this.maxFov=120,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,DOLLY:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.noGyroscope=!1,this.gyroscopeSpeed=.02;var a,c,t,n,o,i,g=this,l=1e-7,E=Math.PI/180,u=180/Math.PI,y=null,w=null,b=0,T=0,h=new THREE.Vector2,d=new THREE.Vector2,p=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector2,v=new THREE.Vector2,_=new THREE.Vector3,R=new THREE.Vector3,x=new THREE.Vector2,S=new THREE.Vector2,M=new THREE.Vector2,P=0,H=0,C=0,A=0,L=1,k=new THREE.Vector3,O=new THREE.Vector3,I=new THREE.Quaternion,D=!1,B=0,F=0,z=null,V={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},j=V.NONE;this.target0=this.target.clone(),this.position0=this.camera.position.clone(),this.zoom0=this.camera.zoom;var N=(new THREE.Quaternion).setFromUnitVectors(r.up,new THREE.Vector3(0,1,0)),X=N.clone().inverse(),Y={type:"change"},Z={type:"start"},q={type:"end"};function W(e){return 2*Math.PI/60/60*e}function U(){return Math.pow(.95,g.zoomSpeed)}function G(e){if(B=F=0,(D=!1)!==g.enabled){if(e.button===g.mouseButtons.ORBIT){if(!0===g.noRotate)return;j=V.ROTATE,h.set(e.clientX,e.clientY)}else if(e.button===g.mouseButtons.DOLLY){if(!0===g.noDolly)return;j=V.DOLLY,x.set(e.clientX,e.clientY)}else if(e.button===g.mouseButtons.PAN){if(!0===g.noPan)return;j=V.PAN,m.set(e.clientX,e.clientY)}j!==V.NONE&&(g.tweenAnimation&&g.tweenAnimation.stop(),document.addEventListener("mousemove",Q,!1),document.addEventListener("mouseup",K,!1),g.dispatchEvent(Z),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-start",{scene:g.scene})),g.update()}}function Q(e){if(!1!==g.enabled){e.preventDefault();var t=g.canvas===document?g.canvas.body:g.canvas;if(j===V.ROTATE){if(!0===g.noRotate)return;d.set(e.clientX,e.clientY),p.subVectors(d,h),g.rotateLeft(-2*Math.PI*p.x/t.clientWidth*g.rotateSpeed),g.rotateUp(-2*Math.PI*p.y/t.clientHeight*g.rotateSpeed),h.copy(d),z&&(B=e.clientX-z.clientX,F=e.clientY-z.clientY),z=e}else if(j===V.DOLLY){if(!0===g.noDolly)return;S.set(e.clientX,e.clientY),M.subVectors(S,x),0<M.y?g.dollyIn():M.y<0&&g.dollyOut(),x.copy(S)}else if(j===V.PAN){if(!0===g.noPan)return;f.set(e.clientX,e.clientY),v.subVectors(f,m),g.pan(v.x,v.y),m.copy(f)}j!==V.NONE&&g.update()}}function K(e){!(D=!(z=null))!==g.enabled&&(document.removeEventListener("mousemove",Q,!1),document.removeEventListener("mouseup",K,!1),g.dispatchEvent(q),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-end",{scene:g.scene}),j=V.NONE)}function J(e){if(!1!==g.enabled&&!0!==g.noZoom&&j===V.NONE){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),0<t?(g.camera.fov=g.camera.fov>g.minFov?g.camera.fov-1:g.minFov,g.camera.updateProjectionMatrix()):t<0&&(g.camera.fov=g.camera.fov<g.maxFov?g.camera.fov+1:g.maxFov,g.camera.updateProjectionMatrix()),g.update(),g.dispatchEvent(Z),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-start",{scene:g.scene}),g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene}),g.dispatchEvent(q),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-end",{scene:g.scene})}}function ee(e){switch(e.keyCode){case g.keys.UP:t=!1;break;case g.keys.BOTTOM:n=!1;break;case g.keys.LEFT:o=!1;break;case g.keys.RIGHT:i=!1}}function te(e){if(!1!==g.enabled&&!0!==g.noKeys){switch(e.keyCode){case g.keys.UP:t=!0;break;case g.keys.BOTTOM:n=!0;break;case g.keys.LEFT:o=!0;break;case g.keys.RIGHT:i=!0}(t||n||o||i)&&(g.tweenAnimation&&g.tweenAnimation.stop(),D=!0,t&&(F=-g.rotateSpeed*g.momentumKeydownFactor),n&&(F=g.rotateSpeed*g.momentumKeydownFactor),o&&(B=-g.rotateSpeed*g.momentumKeydownFactor),i&&(B=g.rotateSpeed*g.momentumKeydownFactor))}}function ne(e){if(B=F=0,(D=!1)!==g.enabled){switch(e.touches.length){case 1:if(!0===g.noRotate)return;j=V.TOUCH_ROTATE,h.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===g.noZoom)return;j=V.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+n*n);P=o,H=g.camera.fov;break;case 3:if(!0===g.noPan)return;j=V.TOUCH_PAN,m.set(e.touches[0].pageX,e.touches[0].pageY);break;default:j=V.NONE}j!==V.NONE&&(g.tweenAnimation&&g.tweenAnimation.stop(),g.dispatchEvent(Z),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-start",{scene:g.scene}))}}function oe(e){if(!1!==g.enabled){e.preventDefault(),e.stopPropagation();var t=g.canvas===document?g.canvas.body:g.canvas;switch(e.touches.length){case 1:if(!0===g.noRotate)return;if(j!==V.TOUCH_ROTATE)return;d.set(e.touches[0].pageX,e.touches[0].pageY),p.subVectors(d,h),g.rotateLeft(-2*Math.PI*p.x/t.clientWidth*g.rotateSpeed),g.rotateUp(-2*Math.PI*p.y/t.clientHeight*g.rotateSpeed),h.copy(d),z&&(B=e.touches[0].pageX-z.pageX,F=e.touches[0].pageY-z.pageY),z={pageX:e.touches[0].pageX,pageY:e.touches[0].pageY},g.update();break;case 2:if(!0===g.noZoom)return;if(j!==V.TOUCH_ZOOM)return;var n=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(n*n+o*o),a=P-i,r=Math.max(g.minFov,Math.min(g.maxFov,H+.1*a));g.camera.fov=r,g.camera.updateProjectionMatrix(),g.update(),g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene});break;case 3:if(!0===g.noPan)return;if(j!==V.TOUCH_PAN)return;f.set(e.touches[0].pageX,e.touches[0].pageY),v.subVectors(f,m),g.pan(v.x,v.y),m.copy(f),g.update();break;default:j=V.NONE}}}function ie(e){!(D=!(z=null))!==g.enabled&&(g.dispatchEvent(q),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-end",{scene:g.scene}),j=V.NONE)}function ae(e){if(!1!==g.enabled&&!0!==g.noGyroscope){var t,n,o,i,a,r,s,c,l,u,h,d,p=(n=new Object({yaw:e.alpha*E,pitch:e.beta*E,roll:e.gamma*E}),r=Math.cos(n.yaw),s=Math.sin(n.yaw),c=Math.cos(n.pitch),l=Math.sin(n.pitch),u=Math.cos(n.roll),h=Math.sin(n.roll),.9999<(d=new Array(s*h-r*l*u,-r*c,r*l*h+s*u,c*u,-l,-c*h,s*l*u+r*h,s*c,-s*l*h+r*u))[3]?(o=Math.atan2(d[2],d[8]),a=Math.PI/2,i=0):d[3]<-.9999?(o=Math.atan2(d[2],d[8]),a=-Math.PI/2,i=0):(o=Math.atan2(-d[6],d[0]),i=Math.atan2(-d[5],d[4]),a=Math.asin(d[3])),new Object({yaw:o,pitch:a,roll:i})),m=p.yaw/E,f=p.pitch/E,v=m;if(70<Math.abs(f)){switch(v=e.alpha,window.orientation){case 0:0<f&&(v+=180);break;case 90:v+=90;break;case-90:v+=-90;break;case 180:f<0&&(v+=180)}v%=360,180<Math.abs(v-m)&&(v+=v<m?360:-360),m=m*(1-(t=Math.min(1,(Math.abs(f)-70)/10)))+v*t}null!==y&&null!==w&&((y<=0&&m<=0||0<=y&&0<=m)&&(b=y-m,g.rotateLeft(b*-g.gyroscopeSpeed)),T=w-f,g.rotateUp(T*g.gyroscopeSpeed)),y=m,w=f}}this.setLastQuaternion=function(e){I.copy(e),g.camera.quaternion.copy(e)},this.getLastPosition=function(){return O},this.rotateLeft=function(e){e&&(A+=e)},this.rotateUp=function(e){e&&(C+=e)},this.panLeft=function(e){var t=g.camera.matrix.elements;_.set(t[0],t[1],t[2]),_.multiplyScalar(-e),k.add(_)},this.panUp=function(e){var t=g.camera.matrix.elements;_.set(t[4],t[5],t[6]),_.multiplyScalar(e),k.add(_)},this.pan=function(e,t){var n=g.canvas===document?g.canvas.body:g.canvas;if(g.camera instanceof THREE.PerspectiveCamera){var o=g.camera.position.clone().sub(g.target).length();o*=Math.tan(g.camera.fov/2*Math.PI/180),g.panLeft(2*e*o/n.clientHeight),g.panUp(2*t*o/n.clientHeight)}else g.camera instanceof THREE.OrthographicCamera?(g.panLeft(e*(g.camera.right-g.camera.left)/n.clientWidth),g.panUp(t*(g.camera.top-g.camera.bottom)/n.clientHeight)):console.warn("IPANORAMA.OrbitControls: encountered an unknown camera type - pan disabled.")},this.momentum=function(){D&&(Math.abs(B)<1e-4&&Math.abs(F)<1e-4?D=!1:(F*=g.momentumDampingFactor,B*=g.momentumDampingFactor,A-=g.momentumScalingFactor*B,C-=g.momentumScalingFactor*F))},this.dollyIn=function(e){void 0===e&&(e=U()),g.camera instanceof THREE.PerspectiveCamera?L/=e:g.camera instanceof THREE.OrthographicCamera?(g.camera.zoom=Math.max(g.minZoom,Math.min(g.maxZoom,g.camera.zoom*e)),g.camera.updateProjectionMatrix(),g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene})):console.warn("IPANORAMA.OrbitControls: encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(e){void 0===e&&(e=U()),g.camera instanceof THREE.PerspectiveCamera?L*=e:g.camera instanceof THREE.OrthographicCamera?(g.camera.zoom=Math.max(g.minZoom,Math.min(g.maxZoom,g.camera.zoom/e)),g.camera.updateProjectionMatrix(),g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene})):console.warn("IPANORAMA.OrbitControls: encountered an unknown camera type - dolly/zoom disabled.")},this.update=function(e){var t=g.camera.position;if(R.copy(t).sub(g.target),R.applyQuaternion(N),a=Math.atan2(R.x,R.z),c=Math.atan2(Math.sqrt(R.x*R.x+R.z*R.z),R.y),g.autoRotate&&j===V.NONE){var n=W(g.autoRotateSpeedX),o=W(g.autoRotateSpeedY);g.rotateLeft(n),c<=g.minPolarAngle+l||c>=g.maxPolarAngle-l?(g.rotateUp(-o),g.rotateLeft(Math.PI),g.autoRotateSpeedY=-g.autoRotateSpeedY):g.rotateUp(o)}g.momentum(),a+=A,c+=C,a=Math.max(g.minAzimuthAngle,Math.min(g.maxAzimuthAngle,a)),c=Math.max(g.minPolarAngle,Math.min(g.maxPolarAngle,c)),c=Math.max(l,Math.min(Math.PI-l,c));var i=R.length()*L;if(i=Math.max(g.minDistance,Math.min(g.maxDistance,i)),g.target.add(k),R.x=i*Math.sin(c)*Math.sin(a),R.y=i*Math.cos(c),R.z=i*Math.sin(c)*Math.cos(a),R.applyQuaternion(X),t.copy(g.target).add(R),g.camera.lookAt(g.target),C=A=0,L=1,k.set(0,0,0),O.distanceToSquared(g.camera.position)>l||8*(1-I.dot(g.camera.quaternion))>l)return!0!==e&&(g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene})),O.copy(g.camera.position),void I.copy(g.camera.quaternion)},this.bind=function(){g.canvas.addEventListener("mousedown",G,!1),g.canvas.addEventListener("mousewheel",J,!1),g.canvas.addEventListener("DOMMouseScroll",J,!1),g.canvas.addEventListener("touchstart",ne,!1),g.canvas.addEventListener("touchend",ie,!1),g.canvas.addEventListener("touchmove",oe,!1),g.canvas.addEventListener("keyup",ee,!1),g.canvas.addEventListener("keydown",te,!1),window.addEventListener("deviceorientation",ae,!1)},this.unbind=function(){g.canvas.removeEventListener("mousedown",G,!1),g.canvas.removeEventListener("mousewheel",J,!1),g.canvas.removeEventListener("DOMMouseScroll",J,!1),g.canvas.removeEventListener("touchstart",ne,!1),g.canvas.removeEventListener("touchend",ie,!1),g.canvas.removeEventListener("touchmove",oe,!1),g.canvas.removeEventListener("keyup",ee,!1),g.canvas.removeEventListener("keydown",te,!1),window.removeEventListener("deviceorientation",ae,!1),document.removeEventListener("mousemove",Q,!1),document.removeEventListener("mouseup",K,!1)},this.reset=function(){j=V.NONE,g.target.copy(g.target0),g.camera.position.copy(g.position0),g.camera.zoom=g.zoom0,g.camera.updateProjectionMatrix(),g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene}),g.update()},this.getAlphaBetaPos=function(){return e=g.camera.position,t=180-Math.atan2(e.x,-e.z)*u,n=Math.sqrt(e.x*e.x+e.z*e.z),o=Math.atan2(e.y,n)*u,{alpha:t,beta:o};var e,t,n,o},this.setAlphaBetaPos=function(e,t,n,o){var i,a,r,s=(a=(90-t)*E,r=e*E,{x:(i=1)*Math.sin(a)*Math.sin(r),y:i*Math.cos(a),z:i*Math.sin(a)*Math.cos(r)});return(s=new THREE.Vector3(s.x,s.y,s.z)).negate(),this.lookAt(s,n,o)},this.lookAt=function(e,t,n){var o=new $.Deferred;if(t){n=n||TWEEN.Easing.Exponential.Out;var i=new THREE.Vector3(0,0,1);i.applyQuaternion(r.quaternion),(a=new THREE.Vector3(e.x,e.y,e.z)).normalize().negate(),i.distanceTo(a)<l?o.resolve():(g.tweenAnimation&&g.tweenAnimation.stop(),g.tweenAnimation=new TWEEN.Tween(i).to(a,t).easing(n).onStart(function(){}).onUpdate(function(e){g.camera.position.copy(i)}).onComplete(function(){o.resolve(),g.tweenAnimation.stop()}).onStop(function(){o.reject()}).start())}else{var a;(a=new THREE.Vector3(e.x,e.y,e.z)).normalize().negate(),g.camera.position.copy(a),s.afterRender=!0,o.resolve()}return o.promise()},this.getZoom=function(){return g.camera.fov},this.setZoom=function(e){e&&(e=Math.max(g.minFov,Math.min(g.maxFov,e)),g.camera.fov=e,g.camera.updateProjectionMatrix(),g.dispatchEvent(Y),g.scene&&g.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:g.scene}))},this.destroy=function(){g.unbind(),g.tweenAnimation&&g.tweenAnimation.stop()},this.update()};OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),OrbitControls.prototype.constructor=OrbitControls;var TransformControls=function(o,e){THREE.Object3D.call(this),o=void 0!==o?o:document,this.visible=!1;var i=new TransformControlsGizmo;this.add(i);var h=new TransformControlsPlane;this.add(h);var a=this;B("camera",e),B("object",void 0),B("enabled",!0),B("axis",null),B("mode","translate"),B("translationSnap",null),B("rotationSnap",null),B("space","world"),B("size",1),B("dragging",!1),B("showX",!0),B("showY",!0),B("showZ",!0);var d={type:"change"},r={type:"mouseDown"},t={type:"mouseUp",mode:a.mode},p={type:"objectChange"},m=new THREE.Raycaster,f=new THREE.Vector3,v=(new THREE.Vector3,new THREE.Quaternion),g={X:new THREE.Vector3(1,0,0),Y:new THREE.Vector3(0,1,0),Z:new THREE.Vector3(0,0,1)},E=(new THREE.Quaternion,new THREE.Vector3,new THREE.Vector3),y=new THREE.Vector3,w=new THREE.Vector3,b=new THREE.Vector3,T=new THREE.Vector3,_=new THREE.Vector3,R=0,n=new THREE.Vector3,s=new THREE.Quaternion,c=new THREE.Vector3,l=new THREE.Vector3,u=new THREE.Quaternion,x=new THREE.Quaternion,S=new THREE.Vector3,M=new THREE.Vector3,P=new THREE.Quaternion,H=new THREE.Vector3,C=new THREE.Vector3,A=new THREE.Quaternion,L=new THREE.Quaternion,k=new THREE.Vector3,$=new THREE.Vector3,O=new THREE.Vector3,I=new THREE.Quaternion,D=new THREE.Vector3;function B(t,e){var n=e;Object.defineProperty(a,t,{get:function(){return void 0!==n?n:e},set:function(e){n!==e&&(n=e,h[t]=e,i[t]=e,a.dispatchEvent({type:t+"-changed",value:e}),a.dispatchEvent(d))}}),a[t]=e,h[t]=e,i[t]=e}function F(e){var t=e.changedTouches?e.changedTouches[0]:e,n=o.getBoundingClientRect();return{x:(t.clientX-n.left)/n.width*2-1,y:-(t.clientY-n.top)/n.height*2+1,button:e.button}}function z(e){a.enabled&&a.pointerHover(F(e))}function V(e){a.enabled&&(document.addEventListener("mousemove",j,!1),a.pointerHover(F(e)),a.pointerDown(F(e)))}function j(e){a.enabled&&a.pointerMove(F(e))}function N(e){a.enabled&&(document.removeEventListener("mousemove",j,!1),a.pointerUp(F(e)))}B("worldPosition",C),B("worldPositionStart",M),B("worldQuaternion",A),B("worldQuaternionStart",P),B("cameraPosition",n),B("cameraQuaternion",s),B("pointStart",E),B("pointEnd",y),B("rotationAxis",b),B("rotationAngle",R),B("eye",$),o.addEventListener("mousedown",V,!1),o.addEventListener("touchstart",V,!1),o.addEventListener("mousemove",z,!1),o.addEventListener("touchmove",z,!1),o.addEventListener("touchmove",j,!1),document.addEventListener("mouseup",N,!1),o.addEventListener("touchend",N,!1),o.addEventListener("touchcancel",N,!1),o.addEventListener("touchleave",N,!1),this.dispose=function(){o.removeEventListener("mousedown",V),o.removeEventListener("touchstart",V),o.removeEventListener("mousemove",z),o.removeEventListener("touchmove",z),o.removeEventListener("touchmove",j),document.removeEventListener("mouseup",N),o.removeEventListener("touchend",N),o.removeEventListener("touchcancel",N),o.removeEventListener("touchleave",N)},this.attach=function(e){this.object=e,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(l,u,S),this.object.matrixWorld.decompose(C,A,k),x.copy(u).inverse(),L.copy(A).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(n,s,c),this.camera instanceof THREE.PerspectiveCamera?$.copy(n).sub(C).normalize():this.camera instanceof THREE.OrthographicCamera&&$.copy(n).normalize(),THREE.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){m.setFromCamera(e,this.camera);var t=m.intersectObjects(i.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(!(void 0===this.object||!0===this.dragging||void 0!==e.button&&0!==e.button||0!==e.button&&void 0!==e.button||null===this.axis)){m.setFromCamera(e,this.camera);var t=m.intersectObjects([h],!0)[0]||!1;if(t){var n=this.space;if("scale"===this.mode?n="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(n="world"),"local"===n&&"rotate"===this.mode){var o=this.rotationSnap;"X"===this.axis&&o&&(this.object.rotation.x=Math.round(this.object.rotation.x/o)*o),"Y"===this.axis&&o&&(this.object.rotation.y=Math.round(this.object.rotation.y/o)*o),"Z"===this.axis&&o&&(this.object.rotation.z=Math.round(this.object.rotation.z/o)*o)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),O.copy(this.object.position),I.copy(this.object.quaternion),D.copy(this.object.scale),this.object.matrixWorld.decompose(M,P,H),E.copy(t.point).sub(M)}this.dragging=!0,r.mode=this.mode,this.dispatchEvent(r)}},this.pointerMove=function(e){var t=this.axis,n=this.mode,o=this.object,i=this.space;if("scale"===n?i="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(i="world"),void 0!==o&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){m.setFromCamera(e,this.camera);var a=m.intersectObjects([h],!0)[0]||!1;if(!1!==a){if(y.copy(a.point).sub(M),"translate"===n)w.copy(y).sub(E),"local"===i&&"XYZ"!==t&&w.applyQuaternion(L),-1===t.indexOf("X")&&(w.x=0),-1===t.indexOf("Y")&&(w.y=0),-1===t.indexOf("Z")&&(w.z=0),"local"===i&&"XYZ"!==t?w.applyQuaternion(I).divide(S):w.applyQuaternion(x).divide(S),o.position.copy(w).add(O),this.translationSnap&&("local"===i&&(o.position.applyQuaternion(v.copy(I).inverse()),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.position.applyQuaternion(I)),"world"===i&&(o.parent&&o.position.add(f.setFromMatrixPosition(o.parent.matrixWorld)),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.parent&&o.position.sub(f.setFromMatrixPosition(o.parent.matrixWorld))));else if("scale"===n){if(-1!==t.search("XYZ")){var r=y.length()/E.length();y.dot(E)<0&&(r*=-1),f.set(r,r,r)}else f.copy(y).divide(E),-1===t.search("X")&&(f.x=1),-1===t.search("Y")&&(f.y=1),-1===t.search("Z")&&(f.z=1);o.scale.copy(D).multiply(f)}else if("rotate"===n){w.copy(y).sub(E);var s=20/C.distanceTo(f.setFromMatrixPosition(this.camera.matrixWorld));"E"===t?(b.copy($),R=y.angleTo(E),T.copy(E).normalize(),_.copy(y).normalize(),R*=_.cross(T).dot($)<0?1:-1):"XYZE"===t?(b.copy(w).cross($).normalize(),R=w.dot(f.copy(b).cross(this.eye))*s):"X"!==t&&"Y"!==t&&"Z"!==t||(b.copy(g[t]),f.copy(g[t]),"local"===i&&f.applyQuaternion(A),R=w.dot(f.cross($).normalize())*s),this.rotationSnap&&(R=Math.round(R/this.rotationSnap)*this.rotationSnap),this.rotationAngle=R,"local"===i&&"E"!==t&&"XYZE"!==t?(o.quaternion.copy(I),o.quaternion.multiply(v.setFromAxisAngle(b,R)).normalize()):(b.applyQuaternion(x),o.quaternion.copy(v.setFromAxisAngle(b,R)),o.quaternion.multiply(I).normalize())}else if("orbit"===n){w.copy(y).sub(E),"local"===i&&"XYZ"!==t&&w.applyQuaternion(L),-1===t.indexOf("X")&&(w.x=0),-1===t.indexOf("Y")&&(w.y=0),-1===t.indexOf("Z")&&(w.z=0),"local"===i&&"XYZ"!==t?w.applyQuaternion(I).divide(S):w.applyQuaternion(x).divide(S),o.position.copy(w).add(O);var c=new THREE.Vector3,l=o.position.clone(),u=(c.distanceTo(l),new THREE.Vector3);u.addVectors(c,l.normalize().multiplyScalar(500)),o.position.copy(u),this.translationSnap&&("local"===i&&(o.position.applyQuaternion(v.copy(I).inverse()),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.position.applyQuaternion(I)),"world"===i&&(o.parent&&o.position.add(f.setFromMatrixPosition(o.parent.matrixWorld)),-1!==t.search("X")&&(o.position.x=Math.round(o.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(o.position.y=Math.round(o.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(o.position.z=Math.round(o.position.z/this.translationSnap)*this.translationSnap),o.parent&&o.position.sub(f.setFromMatrixPosition(o.parent.matrixWorld))))}this.dispatchEvent(d),this.dispatchEvent(p)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(t.mode=this.mode,this.dispatchEvent(t)),this.dragging=!1,void 0===e.button&&(this.axis=null))}};TransformControls.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:TransformControls,isTransformControls:!0});var TransformControlsGizmo=function(){THREE.Object3D.call(this),this.type="TransformControlsGizmo";var e=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:THREE.DoubleSide,fog:!1}),t=new THREE.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),n=e.clone();n.opacity=.15;var o=e.clone();o.opacity=.33;var i=e.clone();i.color.set(16711680);var a=e.clone();a.color.set(65280);var r=e.clone();r.color.set(255);var s=e.clone();s.opacity=.25;var c=s.clone();c.color.set(16776960);var l=s.clone();l.color.set(65535);var u=s.clone();u.color.set(16711935),e.clone().color.set(16776960);var h=t.clone();h.color.set(16711680);var d=t.clone();d.color.set(65280);var p=t.clone();p.color.set(255);var m=t.clone();m.color.set(65535);var f=t.clone();f.color.set(16711935);var v=t.clone();v.color.set(16776960);var g=t.clone();g.color.set(7895160);var E=v.clone();E.opacity=.25;var y=new THREE.CylinderBufferGeometry(0,.05,.2,12,1,!1),w=new THREE.BoxBufferGeometry(.125,.125,.125),b=new THREE.BufferGeometry;b.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var T=function(e,t){for(var n=new THREE.BufferGeometry,o=[],i=0;i<=64*t;++i)o.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return n.addAttribute("position",new THREE.Float32BufferAttribute(o,3)),n},_=function(e,t){var n=new THREE.BufferGeometry;return n.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,1,1],3)),n},R={X:[[new THREE.Mesh(y,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new THREE.Mesh(y,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new THREE.Line(b,h)]],Y:[[new THREE.Mesh(y,a),[0,1,0],null,null,"fwd"],[new THREE.Mesh(y,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new THREE.Line(b,d),null,[0,0,Math.PI/2]]],Z:[[new THREE.Mesh(y,r),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new THREE.Mesh(y,r),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new THREE.Line(b,p),null,[0,-Math.PI/2,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.1,0),s),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),c),[.15,.15,0]],[new THREE.Line(b,v),[.18,.3,0],null,[.125,1,1]],[new THREE.Line(b,v),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),l),[0,.15,.15],[0,Math.PI/2,0]],[new THREE.Line(b,m),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new THREE.Line(b,m),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),u),[.15,0,.15],[-Math.PI/2,0,0]],[new THREE.Line(b,f),[.18,0,.3],null,[.125,1,1]],[new THREE.Line(b,f),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},x={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.2,0),n)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),n),[.2,0,.2],[-Math.PI/2,0,0]]]},S={START:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),o),null,null,null,"helper"]],END:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),o),null,null,null,"helper"]],DELTA:[[new THREE.Line(_(),o),null,null,null,"helper"]],X:[[new THREE.Line(b,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(b,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(b,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},M={X:[[new THREE.Line(T(1,.5),h)],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),i),[0,0,.99],null,[1,3,1]]],Y:[[new THREE.Line(T(1,.5),d),null,[0,0,-Math.PI/2]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new THREE.Line(T(1,.5),p),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),r),[.99,0,0],null,[1,3,1]]],E:[[new THREE.Line(T(1.25,1),E),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),E),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new THREE.Line(T(1,1),g),null,[0,Math.PI/2,0]]]},P={AXIS:[[new THREE.Line(b,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},H={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.1,2,24),n)]],XYZE:[[new THREE.Mesh(new THREE.SphereBufferGeometry(.7,10,8),n)]]},C={X:[[new THREE.Mesh(w,i),[.8,0,0],[0,0,-Math.PI/2]],[new THREE.Line(b,h),null,null,[.8,1,1]]],Y:[[new THREE.Mesh(w,a),[0,.8,0]],[new THREE.Line(b,d),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new THREE.Mesh(w,r),[0,0,.8],[Math.PI/2,0,0]],[new THREE.Line(b,p),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new THREE.Mesh(w,c),[.85,.85,0],null,[2,2,.2]],[new THREE.Line(b,v),[.855,.98,0],null,[.125,1,1]],[new THREE.Line(b,v),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new THREE.Mesh(w,l),[0,.85,.85],null,[.2,2,2]],[new THREE.Line(b,m),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new THREE.Line(b,m),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(w,u),[.85,0,.85],null,[2,.2,2]],[new THREE.Line(b,f),[.855,0,.98],null,[.125,1,1]],[new THREE.Line(b,f),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s),[0,0,1.1]]]},A={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,.5,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new THREE.Mesh(w,n),[.85,.85,0],null,[3,3,.2]]],YZ:[[new THREE.Mesh(w,n),[0,.85,.85],null,[.2,3,3]]],XZ:[[new THREE.Mesh(w,n),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),n),[0,0,1.1]]]},L={X:[[new THREE.Line(b,o.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(b,o.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(b,o.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},k={X:[[new THREE.Mesh(y,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new THREE.Mesh(y,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new THREE.Line(b,h)]],Y:[[new THREE.Mesh(y,a),[0,1,0],null,null,"fwd"],[new THREE.Mesh(y,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new THREE.Line(b,d),null,[0,0,Math.PI/2]]],Z:[[new THREE.Mesh(y,r),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new THREE.Mesh(y,r),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new THREE.Line(b,p),null,[0,-Math.PI/2,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.1,0),s),[0,0,0],[0,0,0]]]},$={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.2,0),n)]]},O={START:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),o),null,null,null,"helper"]],END:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),o),null,null,null,"helper"]],DELTA:[[new THREE.Line(_(),o),null,null,null,"helper"]]},I=function(e){var t=new THREE.Object3D;for(var n in e)for(var o=e[n].length;o--;){var i=e[n][o][0].clone(),a=e[n][o][1],r=e[n][o][2],s=e[n][o][3],c=e[n][o][4];i.name=n,i.tag=c,a&&i.position.set(a[0],a[1],a[2]),r&&i.rotation.set(r[0],r[1],r[2]),s&&i.scale.set(s[0],s[1],s[2]),i.updateMatrix();var l=i.geometry.clone();l.applyMatrix(i.matrix),i.geometry=l,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t},D=new THREE.Vector3(0,0,0),B=new THREE.Euler,F=new THREE.Vector3(0,1,0),z=new THREE.Vector3(0,0,0),V=new THREE.Matrix4,j=new THREE.Quaternion,N=new THREE.Quaternion,X=new THREE.Quaternion,Y=new THREE.Vector3(1,0,0),Z=new THREE.Vector3(0,1,0),q=new THREE.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=I(R)),this.add(this.gizmo.rotate=I(M)),this.add(this.gizmo.scale=I(C)),this.add(this.gizmo.orbit=I(k)),this.add(this.picker.translate=I(x)),this.add(this.picker.rotate=I(H)),this.add(this.picker.scale=I(A)),this.add(this.picker.orbit=I($)),this.add(this.helper.translate=I(S)),this.add(this.helper.rotate=I(P)),this.add(this.helper.scale=I(L)),this.add(this.helper.orbit=I(O)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.picker.orbit.visible=!1,this.updateMatrixWorld=function(){var e=this.space;"scale"===this.mode&&(e="local");var t="local"===e?this.worldQuaternion:X;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.gizmo.orbit.visible="orbit"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode,this.helper.orbit.visible="orbit"===this.mode;var n=[];n=(n=(n=n.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var o=0;o<n.length;o++){var i=n[o];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);var a=this.worldPosition.distanceTo(this.cameraPosition);if(i.scale.set(1,1,1).multiplyScalar(a*this.size/7),"helper"!==i.tag){if(i.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode||"orbit"===this.mode){"X"!==i.name&&"XYZX"!==i.name||.99<Math.abs(F.copy(Y).applyQuaternion(t).dot(this.eye))&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Y"!==i.name&&"XYZY"!==i.name||.99<Math.abs(F.copy(Z).applyQuaternion(t).dot(this.eye))&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Z"!==i.name&&"XYZZ"!==i.name||.99<Math.abs(F.copy(q).applyQuaternion(t).dot(this.eye))&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XY"===i.name&&Math.abs(F.copy(q).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"YZ"===i.name&&Math.abs(F.copy(Y).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XZ"===i.name&&Math.abs(F.copy(Z).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),-1!==i.name.search("X")&&(F.copy(Y).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.x*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Y")&&(F.copy(Z).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.y*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Z")&&(F.copy(q).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.z*=-1:"bwd"===i.tag&&(i.visible=!1))}else"rotate"===this.mode&&(N.copy(t),F.copy(this.eye).applyQuaternion(j.copy(t).inverse()),-1!==i.name.search("E")&&i.quaternion.setFromRotationMatrix(V.lookAt(this.eye,z,Z)),"X"===i.name&&(j.setFromAxisAngle(Y,Math.atan2(-F.y,F.z)),j.multiplyQuaternions(N,j),i.quaternion.copy(j)),"Y"===i.name&&(j.setFromAxisAngle(Z,Math.atan2(F.x,F.z)),j.multiplyQuaternions(N,j),i.quaternion.copy(j)),"Z"===i.name&&(j.setFromAxisAngle(q,Math.atan2(F.y,F.x)),j.multiplyQuaternions(N,j),i.quaternion.copy(j)));i.visible=i.visible&&(-1===i.name.indexOf("X")||this.showX),i.visible=i.visible&&(-1===i.name.indexOf("Y")||this.showY),i.visible=i.visible&&(-1===i.name.indexOf("Z")||this.showZ),i.visible=i.visible&&(-1===i.name.indexOf("E")||this.showX&&this.showY&&this.showZ),i.material._opacity=i.material._opacity||i.material.opacity,i.material._color=i.material._color||i.material.color.clone(),i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled?this.axis&&(i.name===this.axis?i.material.opacity=1:this.axis.split("").some(function(e){return i.name===e})?i.material.opacity=1:i.material.opacity*=.25,i.material.color.lerp(new THREE.Color(1,1,1),.5)):(i.material.opacity*=.5,i.material.color.lerp(new THREE.Color(1,1,1),.5))}else i.visible=!1,"AXIS"===i.name?(i.position.copy(this.worldPositionStart),i.visible=!!this.axis,"X"===this.axis&&(j.setFromEuler(B.set(0,0,0)),i.quaternion.copy(t).multiply(j),.9<Math.abs(F.copy(Y).applyQuaternion(t).dot(this.eye))&&(i.visible=!1)),"Y"===this.axis&&(j.setFromEuler(B.set(0,0,Math.PI/2)),i.quaternion.copy(t).multiply(j),.9<Math.abs(F.copy(Z).applyQuaternion(t).dot(this.eye))&&(i.visible=!1)),"Z"===this.axis&&(j.setFromEuler(B.set(0,Math.PI/2,0)),i.quaternion.copy(t).multiply(j),.9<Math.abs(F.copy(q).applyQuaternion(t).dot(this.eye))&&(i.visible=!1)),"XYZE"===this.axis&&(j.setFromEuler(B.set(0,Math.PI/2,0)),F.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(V.lookAt(z,F,Z)),i.quaternion.multiply(j),i.visible=this.dragging),"E"===this.axis&&(i.visible=!1)):"START"===i.name?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):"END"===i.name?(i.position.copy(this.worldPosition),i.visible=this.dragging):"DELTA"===i.name?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),D.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),D.applyQuaternion(this.worldQuaternionStart.clone().inverse()),i.scale.copy(D),i.visible=this.dragging):(i.quaternion.copy(t),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=-1!==this.axis.search(i.name)))}THREE.Object3D.prototype.updateMatrixWorld.call(this)}};TransformControlsGizmo.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:TransformControlsGizmo,isTransformControlsGizmo:!0});var TransformControlsPlane=function(){THREE.Mesh.call(this,new THREE.PlaneBufferGeometry(1e5,1e5,2,2),new THREE.MeshBasicMaterial({visible:!0,wireframe:!0,side:THREE.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var t=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,1,0),o=new THREE.Vector3(0,0,1),i=new THREE.Vector3,a=new THREE.Vector3,r=new THREE.Vector3,s=new THREE.Matrix4,c=new THREE.Quaternion;this.updateMatrixWorld=function(){var e=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(e="local"),t.set(1,0,0).applyQuaternion("local"===e?this.worldQuaternion:c),n.set(0,1,0).applyQuaternion("local"===e?this.worldQuaternion:c),o.set(0,0,1).applyQuaternion("local"===e?this.worldQuaternion:c),r.copy(n),this.mode){case"translate":case"scale":switch(this.axis){case"X":r.copy(this.eye).cross(t),a.copy(t).cross(r);break;case"Y":r.copy(this.eye).cross(n),a.copy(n).cross(r);break;case"Z":r.copy(this.eye).cross(o),a.copy(o).cross(r);break;case"XY":a.copy(o);break;case"YZ":a.copy(t);break;case"XZ":r.copy(o),a.copy(n);break;case"XYZ":case"E":a.set(0,0,0)}break;case"rotate":case"orbit":default:a.set(0,0,0)}0===a.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(i.set(0,0,0),a,r),this.quaternion.setFromRotationMatrix(s)),THREE.Object3D.prototype.updateMatrixWorld.call(this)}};TransformControlsPlane.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:TransformControlsPlane,isTransformControlsPlane:!0});var PointEditor=function(s,e){this.cfg=e,this.enabled=e.enabled,this.defaultPoint={image:e.image,width:e.width,height:e.height,opacity:e.opacity},this.transformControl=new TransformControls(s.canvas,s.camera),this.transformControl.mode="orbit",s.scene.add(this.transformControl);var c=this,n=27,o=46,l=new THREE.Raycaster,i=this.transformControl;this.bind=function(){s.$canvas.on("keydown",t),s.$canvas.on("keyup",a),s.$canvas.on("click",r),s.$canvas.on("dblclick",u),i.addEventListener("dragging-changed",h),i.addEventListener("mode-changed",d)},this.unbind=function(){s.$canvas.off("keydown",t),s.$canvas.off("keyup",a),s.$canvas.off("click",r),s.$canvas.off("dblclick",u),i.removeEventListener("dragging-changed",h),i.removeEventListener("mode-changed",d)},this.detach=function(){i.detach()},this.attach=function(e){e&&i.attach(e.mesh)},this.getSceneIntersectPoint=function(e,t){var n=s.canvas.getBoundingClientRect(),o=new THREE.Vector2;o.x=(e-n.left)/n.width*2-1,o.y=-(t-n.top)/n.height*2+1,l.setFromCamera(o,s.camera);var i=l.intersectObjects([s.mesh],!1);if(i.length){var a=i[0].point,r=new THREE.Vector3;return s.mesh.getWorldPosition(r),new THREE.Vector3(parseFloat((a.x-r.x).toFixed(2)),parseFloat((a.y-r.y).toFixed(2)),parseFloat((a.z-r.z).toFixed(2)))}return null},this.addPointToCenter=function(e){var t=s.canvas.getBoundingClientRect(),n=t.left+t.width/2,o=t.top+t.height/2,i=s.scene.position.clone(),a=c.getSceneIntersectPoint(n,o),r=(i.distanceTo(a),new THREE.Vector3);return r.addVectors(i,a.normalize().multiplyScalar(500)),s.addPoint(c.createPoint(r),e)},this.createPoint=function(e){return new Point({pos:e,image:c.defaultPoint.image,width:c.defaultPoint.width,height:c.defaultPoint.height,opacity:c.defaultPoint.opacity})};var t=function(e){c.enabled},a=function(e){if(!1!==c.enabled&&i.object)switch(e.keyCode){case o:if("point"==i.object.userData.type){var t=s.findPointByMesh(i.object);i.detach(),s.removePoint(t)}break;case n:i.object&&s.deselectPoint(i.object.userData.point),i.detach()}},r=function(e){if(!1!==c.enabled){var t=s.canvas.getBoundingClientRect(),n=new THREE.Vector2;n.x=(e.clientX-t.left)/t.width*2-1,n.y=-(e.clientY-t.top)/t.height*2+1,l.setFromCamera(n,s.camera);var o=l.intersectObjects(s.scene.children);o.length&&"point"===o[0].object.userData.type?i.object!==o[0].object&&(i.attach(o[0].object),s.selectPoint(i.object.userData.point)):(i.object&&s.deselectPoint(i.object.userData.point),i.detach())}},u=function(e){if(!1!==c.enabled){var t=s.scene.position.clone(),n=c.getSceneIntersectPoint(e.clientX,e.clientY),o=(t.distanceTo(n),new THREE.Vector3);o.addVectors(t,n.normalize().multiplyScalar(500)),s.addPoint(c.createPoint(o))}},h=function(e){e.value?s.dragstartPoint(e.target.object.userData.point):s.dragendPoint(e.target.object.userData.point),s.control.enabled=!e.value},d=function(e){s.transformModeChanged(e.value)}},PointControl=function(a){var r=this,n=new THREE.Frustum,s=null;this.bind=function(){a.control.addEventListener("change",e),a.control.addEventListener("start",t),a.control.addEventListener("end",l)},this.unbind=function(){a.control.removeEventListener("change",e),a.control.removeEventListener("start",t),a.control.removeEventListener("end",l)},this.update=function(){n.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++)e=a.points[t],i(n,e,!0)},this.show=function(){n.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++){(e=a.points[t]).mesh.visible=!0,i(n,e,!1)}},this.hide=function(){for(var e=0;e<a.points.length;e++){var t=a.points[e];o(t)}},this.getScreenCoord=function(e){return e.project(a.camera),e.x=Math.round((.5+e.x/2)*(a.canvas.width/window.devicePixelRatio)),e.y=Math.round((.5-e.y/2)*(a.canvas.height/window.devicePixelRatio)),{x:e.x,y:e.y}};var o=function(e){e.mesh.visible=!1,e.visible&&(e.visible=!1,a.$canvas.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))},i=function(e,t,n){e.containsPoint(t.mesh.position)?(c(t),t.visible||(t.visible=!0,a.$canvas.trigger("ipanorama:scene-point-show",{scene:a,point:t})),n&&a.$canvas.trigger("ipanorama:scene-point-change",{scene:a,point:t})):t.visible&&(t.visible=!1,a.$canvas.trigger("ipanorama:scene-point-hide",{scene:a,point:t}))},c=function(e){e.mesh.quaternion.copy(a.camera.quaternion);var t=e.mesh.position.clone();if(e.screenPos=r.getScreenCoord(t),s!=a.camera.fov){e.mesh.updateMatrixWorld();var n=e.mesh.geometry.vertices[0].clone(),o=e.mesh.geometry.vertices[1].clone(),i=e.mesh.geometry.vertices[2].clone();n.applyMatrix4(e.mesh.matrixWorld),o.applyMatrix4(e.mesh.matrixWorld),i.applyMatrix4(e.mesh.matrixWorld),n=r.getScreenCoord(n),o=r.getScreenCoord(o),i=r.getScreenCoord(i),e.screenWidth=o.x-n.x,e.screenHeight=i.y-n.y,s=a.camera.fov}},e=function(){r.update()},t=function(){},l=function(){}},Point=function(t){this.cfg=t,this.loaded=!1,this.visible=!1,this.texture=null,this.geometry=new THREE.PlaneGeometry(t.width,t.height),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},opacity:{value:t.opacity}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * (modelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0) + vec4(position.x, position.y, 0.0, 0.0));","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform vec3 color;","uniform float opacity;","void main() {","vec2 uv = vUv;","vec4 fragColor = texture2D(texture, uv);","fragColor.a *= opacity;","if (fragColor.a < 0.3 ) discard;","gl_FragColor = fragColor;","}"].join("\n"),side:THREE.DoubleSide,transparent:!0,depthTest:!1,depthWrite:!1}),this.mesh=new THREE.Mesh(this.geometry,this.material),(this.mesh.userData.point=this).mesh.userData.type="point",this.mesh.visible=!1,this.mesh.position.set(t.pos.x,t.pos.y,t.pos.z);var n=this;this.load=function(e){(e=e||t.image)?"string"==typeof e?Utils.TextureLoader.load(e,o,i,a,!1):e instanceof HTMLImageElement&&o(new THREE.Texture(e)):console.warn("IPANORAMA.Point: image source undefined")},this.setTexture=function(e){n.texture&&n.texture.dispose(),n.texture=e,n.material.uniforms.texture.value=n.texture,n.material.needsUpdate=!0},this.setOpacity=function(e){n.material.uniforms.opacity.value=e,n.material.needsUpdate=!0},this.destroy=function(){n.geometry&&n.geometry.dispose(),n.material&&n.material.dispose(),n.texture&&n.texture.dispose()};var o=function(e){n.loaded=!0,n.setTexture(e)},i=function(e){},a=function(){console.warn("IPANORAMA.Point: undefined error while loading")}},PlaneEditor=function(c,e){this.cfg=e,this.enabled=e.enabled,this.defaultPlane={image:e.image,width:e.width,height:e.height,opacity:e.opacity,billboard:e.billboard},this.transformControl=new TransformControls(c.canvas,c.camera),this.transformControl.mode="translate",c.scene.add(this.transformControl);var l=this,o=27,i=46,a=9,r=["translate","rotate"],s=new THREE.Raycaster,u=this.transformControl;this.bind=function(){c.$canvas.on("keydown",t),c.$canvas.on("keyup",n),c.$canvas.on("click",h),c.$canvas.on("dblclick",d),u.addEventListener("dragging-changed",p),u.addEventListener("mode-changed",m)},this.unbind=function(){c.$canvas.off("keydown",t),c.$canvas.off("keyup",n),c.$canvas.off("click",h),c.$canvas.off("dblclick",d),u.removeEventListener("dragging-changed",p),u.removeEventListener("mode-changed",m)},this.detach=function(){u.detach()},this.attach=function(e){e&&u.attach(e.mesh)},this.getSceneIntersectPoint=function(e,t){var n=c.canvas.getBoundingClientRect(),o=new THREE.Vector2;o.x=(e-n.left)/n.width*2-1,o.y=-(t-n.top)/n.height*2+1,s.setFromCamera(o,c.camera);var i=s.intersectObjects([c.mesh],!1);if(i.length){var a=i[0].point,r=new THREE.Vector3;return c.mesh.getWorldPosition(r),new THREE.Vector3(parseFloat((a.x-r.x).toFixed(2)),parseFloat((a.y-r.y).toFixed(2)),parseFloat((a.z-r.z).toFixed(2)))}return null},this.addPlaneToCenter=function(e){var t=c.canvas.getBoundingClientRect(),n=t.left+t.width/2,o=t.top+t.height/2,i=c.scene.position.clone(),a=l.getSceneIntersectPoint(n,o),r=(i.distanceTo(a),new THREE.Vector3),s={x:THREE.Math.radToDeg(c.camera.rotation.x),y:THREE.Math.radToDeg(c.camera.rotation.y),z:THREE.Math.radToDeg(c.camera.rotation.z)};return r.addVectors(i,a.normalize().multiplyScalar(500)),c.addPlane(l.createPlane(r,s),e)},this.createPlane=function(e,t){return new Plane({pos:e,rotate:t,image:l.defaultPlane.image,width:l.defaultPlane.width,height:l.defaultPlane.height,opacity:l.defaultPlane.opacity,billboard:l.defaultPlane.billboard})};var t=function(e){if(!1!==l.enabled)return!u.object&&void 0},n=function(e){if(!1!==l.enabled&&u.object)switch(e.keyCode){case i:if("plane"==u.object.userData.type){var t=c.findPlaneByMesh(u.object);u.detach(),c.removePlane(t)}break;case o:u.object&&c.deselectPlane(u.object.userData.plane),u.detach();break;case a:for(var n=0;n<r.length&&r[n]!=u.mode;n++);u.mode=r[n<r.length-1?n+1:0]}},h=function(e){if(!1!==l.enabled){var t=c.canvas.getBoundingClientRect(),n=new THREE.Vector2;n.x=(e.clientX-t.left)/t.width*2-1,n.y=-(e.clientY-t.top)/t.height*2+1,s.setFromCamera(n,c.camera);var o=s.intersectObjects(c.scene.children);o.length&&"plane"===o[0].object.userData.type?u.object!==o[0].object&&(u.attach(o[0].object),c.selectPlane(u.object.userData.plane)):(u.object&&c.deselectPlane(u.object.userData.plane),u.detach())}},d=function(e){if(!1!==l.enabled){var t=c.scene.position.clone(),n=l.getSceneIntersectPoint(e.clientX,e.clientY),o=(t.distanceTo(n),new THREE.Vector3),i={x:THREE.Math.radToDeg(c.camera.rotation.x),y:THREE.Math.radToDeg(c.camera.rotation.y),z:THREE.Math.radToDeg(c.camera.rotation.z)};o.addVectors(t,n.normalize().multiplyScalar(500)),c.addPlane(l.createPlane(o,i))}},p=function(e){e.value?c.dragstartPlane(e.target.object.userData.plane):c.dragendPlane(e.target.object.userData.plane),c.control.enabled=!e.value},m=function(e){c.transformModeChanged(e.value)}},Plane=function(t){this.cfg=t,this.loaded=!1,this.texture=null,this.geometry=new THREE.PlaneGeometry(t.width,t.height),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},opacity:{value:t.opacity},billboard:{value:t.billboard}},vertexShader:["varying vec2 vUv;","uniform bool billboard;","void main() {","vUv = uv;","if(billboard) {","gl_Position = projectionMatrix * (modelViewMatrix * vec4(0.0, 0.0, 0.0, 1.0) + vec4(position.x, position.y, 0.0, 0.0));","} else {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform vec3 color;","uniform float opacity;","void main() {","vec2 uv = vUv;","vec4 fragColor = texture2D(texture, uv);","fragColor.a *= opacity;","if (fragColor.a < 0.3 ) discard;","gl_FragColor = fragColor;","}"].join("\n"),side:THREE.DoubleSide,transparent:!0}),this.mesh=new THREE.Mesh(this.geometry,this.material),(this.mesh.userData.plane=this).mesh.userData.type="plane",this.mesh.visible=!0,this.mesh.position.set(t.pos.x,t.pos.y,t.pos.z),this.mesh.rotation.x=THREE.Math.degToRad(t.rotate.x),this.mesh.rotation.y=THREE.Math.degToRad(t.rotate.y),this.mesh.rotation.z=THREE.Math.degToRad(t.rotate.z);var n=this;this.load=function(e){(e=e||t.image)?"string"==typeof e?Utils.TextureLoader.load(e,o,i,a,!1):e instanceof HTMLImageElement&&o(new THREE.Texture(e)):console.warn("IPANORAMA.Plane: image source undefined")},this.setTexture=function(e){n.texture&&n.texture.dispose(),n.texture=e,n.material.uniforms.texture.value=n.texture,n.material.needsUpdate=!0},this.setOpacity=function(e){n.material.uniforms.opacity.value=e,n.material.needsUpdate=!0},this.destroy=function(){n.geometry&&n.geometry.dispose(),n.material&&n.material.dispose(),n.texture&&n.texture.dispose()};var o=function(e){n.loaded=!0,n.setTexture(e)},i=function(e){},a=function(){console.warn("IPANORAMA.Plane: undefined error while loading")}},AutoRotateControl=function(e,t){this.cfg=t,this.enabled=t.enabled,this.speedX=t.speedX,this.speedY=t.speedY,this.speedZ=t.speedZ,this.inactivityDelay=t.inactivityDelay;var n=this,o=null;this.bind=function(){e.control.addEventListener("end",i),n.start()},this.unbind=function(){e.control.removeEventListener("end",i),n.stop()},this.start=function(){n.enabled&&(e.control.autoRotate=!0,e.control.autoRotateSpeedX=n.speedX,e.control.autoRotateSpeedY=n.speedY,e.control.autoRotateSpeedZ=n.speedZ)},this.stop=function(){clearTimeout(o),o=setTimeout(a,n.inactivityDelay),e.control.autoRotate=!1};var i=function(){n.stop()},a=function(){n.start()}},SceneBase=function(e,t,n){var o=e.clientWidth,i=e.clientHeight,a={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1};this.cfg=t,this.smartRequest=n,this.canvas=e,this.$canvas=$(e),this.loaded=!1,this.afterRender=!0,this.raycaster=new THREE.Raycaster,this.fbo=new THREE.WebGLRenderTarget(o,i,a),this.camera=new THREE.PerspectiveCamera(t.cameraFov,o/i,1,1e5),this.camera.position.z=1,this.camera.updateProjectionMatrix(),this.sceneDfd=null,this.scene=null,this.mesh=null};Object.assign(SceneBase.prototype,{update:function(){},render:function(e,t){this.loaded&&(e.setClearColor(0),t?(e.setRenderTarget(this.fbo),e.clear()):e.setRenderTarget(null),e.render(this.scene,this.camera),this.afterRender&&(this.pointControl&&this.pointControl.update(),this.afterRender=!1))},load:function(){this.$canvas.trigger("ipanorama:scene-before-load",{scene:this})},onLoad:function(){this.loaded=!0,this.afterRender=!0,this.onReady(),this.$canvas.trigger("ipanorama:scene-after-load",{scene:this})},onReady:function(){this.sceneDfd&&this.sceneDfd.resolve()},onProgress:function(e){this.$canvas.trigger("ipanorama:scene-progress",{scene:this,progress:e})},onError:function(){this.loaded=!1,this.sceneDfd&&this.sceneDfd.reject(),this.$canvas.trigger("ipanorama:scene-error",{scene:this})},onShowStart:function(){this.$canvas.trigger("ipanorama:scene-show-start",{scene:this})},onShowUpdate:function(e){},onShowComplete:function(){this.$canvas.trigger("ipanorama:scene-show-complete",{scene:this})},onHideStart:function(){this.$canvas.trigger("ipanorama:scene-hide-start",{scene:this})},onHideUpdate:function(e){},onHideComplete:function(){this.$canvas.trigger("ipanorama:scene-hide-complete",{scene:this})},onWindowResize:function(e,t){this.camera instanceof THREE.PerspectiveCamera&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix()),this.fbo.setSize(e,t),this.pointControl&&this.pointControl.update()},get:function(){return this.sceneDfd&&this.sceneDfd.reject(),this.sceneDfd=new $.Deferred,this.sceneDfd.promise()},destroy:function(){this.control&&this.control.destroy(),this.control=null},addPoint:function(e,t){return this.points&&e?(e.load(),this.points.push(e),this.scene.add(e.mesh),!t&&this.$canvas.trigger("ipanorama:scene-point-add",{scene:this,point:e}),this.loaded&&this.pointControl.show(),e):null},removePoint:function(e,t){if(this.points&&e){for(var n=null,o=0;o<this.points.length;o++)Object.is(e,this.points[o])&&(n=o);null!=n&&(this.pointEditor&&this.pointEditor.detach(),e=this.points[n],this.scene.remove(e.mesh),e.destroy(),this.points.splice(n,1),!t&&this.$canvas.trigger("ipanorama:scene-point-remove",{scene:this,point:e}))}},removePoints:function(e){if(this.points){this.pointEditor&&this.pointEditor.detach();for(var t=0;t<this.points.length;t++){var n=this.points[t];this.scene.remove(n.mesh),n.destroy(),!e&&this.$canvas.trigger("ipanorama:scene-point-remove",{scene:this,point:n})}this.points=[]}},dragstartPoint:function(e){this.points&&e&&this.$canvas.trigger("ipanorama:scene-point-dragstart",{scene:this,point:e})},dragendPoint:function(e){this.points&&e&&this.$canvas.trigger("ipanorama:scene-point-dragend",{scene:this,point:e})},selectPoint:function(e){this.points&&e&&this.$canvas.trigger("ipanorama:scene-point-select",{scene:this,point:e})},deselectPoint:function(e){this.points&&e&&this.$canvas.trigger("ipanorama:scene-point-deselect",{scene:this,point:e})},findPointByMesh:function(e){for(var t=0;t<this.points.length;t++)if(Object.is(e,this.points[t].mesh))return this.points[t];return null},addPlane:function(e,t){return this.planes&&e?(e.load(),this.planes.push(e),this.scene.add(e.mesh),!t&&this.$canvas.trigger("ipanorama:scene-plane-add",{scene:this,plane:e}),e):null},removePlane:function(e,t){if(this.planes&&e){for(var n=null,o=0;o<this.planes.length;o++)Object.is(e,this.planes[o])&&(n=o);null!=n&&(this.planeEditor&&this.planeEditor.detach(),e=this.planes[n],this.scene.remove(e.mesh),e.destroy(),this.planes.splice(n,1),!t&&this.$canvas.trigger("ipanorama:scene-plane-remove",{scene:this,plane:e}))}},removePlanes:function(e){if(this.planes){this.planeEditor&&this.planeEditor.detach();for(var t=0;t<this.planes.length;t++){var n=this.planes[t];this.scene.remove(n.mesh),n.destroy(),!e&&this.$canvas.trigger("ipanorama:scene-plane-remove",{scene:this,plane:n})}this.planes=[]}},dragstartPlane:function(e){this.planes&&e&&this.$canvas.trigger("ipanorama:scene-plane-dragstart",{scene:this,plane:e})},dragendPlane:function(e){this.planes&&e&&this.$canvas.trigger("ipanorama:scene-plane-dragend",{scene:this,plane:e})},selectPlane:function(e){this.planes&&e&&this.$canvas.trigger("ipanorama:scene-plane-select",{scene:this,plane:e})},deselectPlane:function(e){this.planes&&e&&this.$canvas.trigger("ipanorama:scene-plane-deselect",{scene:this,plane:e})},findPlaneByMesh:function(e){for(var t=0;t<this.planes.length;t++)if(Object.is(e,this.planes[t].mesh))return this.planes[t];return null},transformModeChanged:function(e){this.$canvas.trigger("ipanorama:transform-mode-changed",{scene:this,mode:e})},lookAt:function(e){this.control&&this.control.lookAt(e)}});var SceneSphere=function(e,t,n){SceneBase.call(this,e,t,n),this.image=t.image,this.texture=null,this.geometry=new THREE.SphereGeometry(5e3,60,40),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},opacity:{value:1},translationX:{value:1},translationY:{value:1},translationZ:{value:1},rotationX:{value:0},rotationY:{value:0},rotationZ:{value:0},scaleX:{value:1},scaleY:{value:1},scaleZ:{value:1}},vertexShader:["varying vec2 vUv;","varying mat4 vPosition;","uniform float translationX;","uniform float translationY;","uniform float translationZ;","uniform float rotationX;","uniform float rotationY;","uniform float rotationZ;","uniform float scaleX;","uniform float scaleY;","uniform float scaleZ;","void main() {","vUv = uv;","mat4 tPos = mat4(vec4(1.0,0.0,0.0,0.0),","vec4(0.0,1.0,0.0,0.0),","vec4(0.0,0.0,1.0,0.0),","vec4(translationX,translationY,translationZ,1.0));","mat4 rXPos = mat4(vec4(1.0,0.0,0.0,0.0),","vec4(0.0,cos(rotationX),-sin(rotationX),0.0),","vec4(0.0,sin(rotationX),cos(rotationX),0.0),","vec4(0.0,0.0,0.0,1.0));","mat4 rYPos = mat4(vec4(cos(rotationY),0.0,sin(rotationY),0.0),","vec4(0.0,1.0,0.0,0.0),","vec4(-sin(rotationY),0.0,cos(rotationY),0.0),","vec4(0.0,0.0,0.0,1.0));","mat4 rZPos = mat4(vec4(cos(rotationZ),-sin(rotationZ),0.0,0.0),","vec4(sin(rotationZ),cos(rotationZ),0.0,0.0),","vec4(0.0,0.0,1.0,0.0),","vec4(0.0,0.0,0.0,1.0));","mat4 sPos = mat4(vec4(scaleX,0.0,0.0,0.0),","vec4(0.0,scaleY,0.0,0.0),","vec4(0.0,0.0,scaleZ,0.0),","vec4(0.0,0.0,0.0,1.0));","vPosition = tPos * rXPos * rZPos * rYPos * sPos;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform float opacity;","void main() {","vec2 uv = vUv;","uv.x = 1.0 - uv.x;","vec4 color = texture2D(texture, uv);","color.a *= opacity;","gl_FragColor = color;","}"].join("\n"),side:THREE.DoubleSide}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new OrbitControls(e,this.camera,this),this.autoRotateControl=new AutoRotateControl(this,t.autoRotate),this.points=[],this.pointEditor=new PointEditor(this,t.pointEditor),this.pointControl=new PointControl(this),this.planes=[],this.planeEditor=new PlaneEditor(this,t.planeEditor)};SceneSphere.prototype=Object.create(SceneBase.prototype),SceneSphere.prototype.constructor=SceneSphere,Object.assign(SceneSphere.prototype,{update:function(){this.control.update(),SceneBase.prototype.update.call(this)},load:function(e){if(SceneBase.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneSphere: image source undefined"),void this.onError();"string"==typeof e?(this.smartRequest&&this.smartRequest.abort(),Utils.TextureLoader.load(e,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)):e instanceof HTMLImageElement&&this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){SceneBase.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),SceneBase.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),SceneBase.prototype.onHideStart.call(this)},get:function(e){return e&&this.load(this.image),SceneBase.prototype.get.call(this)},destroy:function(){this.control.destroy(),this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,SceneBase.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind(),this.planeEditor.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind(),this.planeEditor.unbind()}});var SceneCube=function(e,t,n){SceneBase.call(this,e,t,n),this.image=t.image,this.size=6e3,this.texture=null,this.geometry=new THREE.BoxGeometry(this.size,this.size,this.size),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:new THREE.Texture},flip:{value:-1},opacity:{value:0}},vertexShader:["varying vec3 vWorldDirection;","void main() {","vWorldDirection = normalize((modelMatrix * vec4(position, 0.0)).xyz);","vec4 vPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fragmentShader:["varying vec3 vWorldDirection;","uniform samplerCube texture;","uniform float flip;","uniform float opacity;","void main() {","vec4 color = textureCube(texture, vec3( flip * vWorldDirection.x, vWorldDirection.yz ));","color.a = opacity;","gl_FragColor = color;","}"].join("\n"),side:THREE.DoubleSide}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new OrbitControls(e,this.camera,this),this.autoRotateControl=new AutoRotateControl(this,t.autoRotate),this.points=[],this.pointEditor=new PointEditor(this,t.pointEditor),this.pointControl=new PointControl(this),this.planes=[],this.planeEditor=new PlaneEditor(this,t.planeEditor)};SceneCube.prototype=Object.create(SceneBase.prototype),SceneCube.prototype.constructor=SceneCube,Object.assign(SceneCube.prototype,{update:function(){this.control.update(),SceneBase.prototype.update.call(this)},load:function(e){if(SceneBase.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneCube: image source undefined"),void this.onError();if("string"==typeof e)this.smartRequest&&this.smartRequest.abort(),IPANORAMA.Utils.CubeOneTextureLoader.load(this.image,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest);else{if(!$.isArray(e)||6!=e.length)return console.warn("IPANORAMA.SceneCube: image source should be an array of 6 images"),void this.onError();this.smartRequest&&this.smartRequest.abort(),IPANORAMA.Utils.CubeSixTextureLoader.load(this.image,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)}},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){SceneBase.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),SceneBase.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),SceneBase.prototype.onHideStart.call(this)},get:function(e){return e&&this.load(this.image),SceneBase.prototype.get.call(this)},destroy:function(){this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,SceneBase.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind(),this.planeEditor.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind(),this.planeEditor.unbind()}});var SceneGoogleStreetView=function(e,t,n){SceneBase.call(this,e,t,n),this.panoId=t.panoId,this.location=t.location,this.zoom=2,this.gsvLoader=new GSVPANO.PanoLoader,this.texture=null,this.geometry=new THREE.SphereGeometry(5e3,60,40),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform float opacity;","void main() {","vec2 uv = vUv;","uv.x = 1.0 - uv.x;","vec4 color = texture2D(texture, uv);","color.a *= opacity;","gl_FragColor = color;","}"].join("\n"),side:THREE.DoubleSide}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new OrbitControls(e,this.camera,this),this.autoRotateControl=new AutoRotateControl(this,t.autoRotate),this.points=[],this.pointEditor=new PointEditor(this,t.pointEditor),this.pointControl=new PointControl(this),this.planes=[],this.planeEditor=new PlaneEditor(this,t.planeEditor)};SceneGoogleStreetView.prototype=Object.create(SceneBase.prototype),SceneGoogleStreetView.prototype.constructor=SceneGoogleStreetView,Object.assign(SceneGoogleStreetView.prototype,{update:function(){this.control.update()},load:function(e){SceneBase.prototype.load.call(this);var t=this;if(!e)return console.warn("IPANORAMA.SceneGoogleStreetView: location source undefined"),void this.onError();if("string"==typeof e)this.panoId=e,this.gsvLoader.onPanoramaLoad=this.onPanoramaLoad.bind(this),this.gsvLoader.onProgress=this.onProgress.bind(this),this.gsvLoader.onError=function(){console.warn("IPANORAMA.SceneGoogleStreetView: location source is wrong"),t.onError()},this.gsvLoader.setZoom(this.zoom),this.gsvLoader.loadById(this.panoId);else{if(!e.hasOwnProperty("lat")||!e.hasOwnProperty("lng"))return console.warn("IPANORAMA.SceneGoogleStreetView: location source should contain lat & lng parameters"),void this.onError();this.location=e,this.gsvLoader.onPanoramaLoad=this.onPanoramaLoad.bind(this),this.gsvLoader.onProgress=this.onProgress.bind(this),this.gsvLoader.onError=function(){console.warn("IPANORAMA.SceneGoogleStreetView: location source is wrong"),t.onError()},this.gsvLoader.setZoom(this.zoom),this.gsvLoader.loadByLocation(new google.maps.LatLng(this.location.lat,this.location.lng))}},onPanoramaLoad:function(e){this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){SceneBase.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),SceneBase.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),SceneBase.prototype.onHideStart.call(this)},get:function(e){return e&&this.load(this.panoId||this.location),SceneBase.prototype.get.call(this)},destroy:function(){this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,SceneBase.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind(),this.planeEditor.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind(),this.planeEditor.unbind()}});var LittlePlanetControls=function(e,t,n){this.canvas=e,this.material=t,this.scene=n,(this.scene.control=this).enabled=!0,this.noZoom=!1,this.zoomSpeed=1,this.minZoom=0,this.maxZoom=1/0,this.noRotate=!1,this.rotateSpeedX=.3,this.rotateSpeedY=.3,this.autoRotate=!1,this.autoRotateSpeedX=.3,this.autoRotateSpeedY=0,this.autoRotateSpeedZ=0,this.noKeys=!1,this.keySpeed=.3,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.vectorX=new THREE.Vector3(1,0,0),this.vectorY=new THREE.Vector3(0,1,0);var o,i,a,r,c=this,l=!1,u=new THREE.Vector2,s=new THREE.Quaternion,h=new THREE.Quaternion,d=new THREE.Quaternion,p={alpha:0,beta:0},m={type:"change"},f={type:"start"},v={type:"end"};function g(e,t){s.setFromAxisAngle(c.vectorY,e),h.setFromAxisAngle(c.vectorX,t),d.multiply(s).multiply(h),p.alpha+=THREE.Math.radToDeg(e),p.beta+=THREE.Math.radToDeg(t),p.alpha=Math.sign(p.alpha)*(Math.abs(p.alpha)-360*Math.floor(Math.abs(p.alpha)/360)),p.beta=Math.sign(p.beta)*(Math.abs(p.beta)-360*Math.floor(Math.abs(p.beta)/360))}function E(e){c.material.uniforms.zoom.value-=e*c.zoomSpeed,c.material.uniforms.zoom.value=Math.max(c.minZoom,Math.min(c.maxZoom,c.material.uniforms.zoom.value))}function y(e){if(!1!==c.enabled){var t=0<=e.clientX?e.clientX:e.touches[0].clientX,n=0<=e.clientY?e.clientY:e.touches[0].clientY;switch(e.touches&&e.touches.length||1){case 1:l=!0,u.set(t,n);break;case 2:var o=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(o*o+i*i);u.pinchDistance=a}c.dispatchEvent(f),c.update()}}function w(e){if(!1!==c.enabled&&l){var t=0<=e.clientX?e.clientX:e.touches[0].clientX,n=0<=e.clientY?e.clientY:e.touches[0].clientY;switch(e.touches&&e.touches.length||1){case 1:if(!0===c.noRotate)return;var o=THREE.Math.degToRad((t-u.x)*c.rotateSpeedX),i=THREE.Math.degToRad((n-u.y)*c.rotateSpeedY);l&&(g(o,i),u.set(t,n),c.update(),c.dispatchEvent(m));break;case 2:var a=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,s=Math.sqrt(a*a+r*r);E(u.pinchDistance-s),c.update(),c.dispatchEvent(m)}}}function b(e){l=!1,c.dispatchEvent(v)}function T(e){if(!1!==c.enabled&&!0!==c.noZoom){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),E(t),c.update()}}function _(e){switch(e.keyCode){case c.keys.UP:o=!1;break;case c.keys.BOTTOM:i=!1;break;case c.keys.LEFT:a=!1;break;case c.keys.RIGHT:r=!1}}function R(e){if(!1!==c.enabled&&!0!==c.noKeys){switch(e.keyCode){case c.keys.UP:o=!0;break;case c.keys.BOTTOM:i=!0;break;case c.keys.LEFT:a=!0;break;case c.keys.RIGHT:r=!0}(o||i||a||r)&&(o&&g(0,c.keySpeed),i&&g(0,-c.keySpeed),a&&g(c.keySpeed,0),r&&g(-c.keySpeed,0))}}this.rotateLeft=function(e){e&&g(e,0)},this.rotateUp=function(e){e&&g(0,e)},this.update=function(){if(c.autoRotate&&!l){var e=!1;if(c.autoRotateSpeedZ){var t=THREE.Math.degToRad(c.autoRotateSpeedZ/10),n=THREE.Math.degToRad(0),o=new THREE.Vector3(0,0,1),i=new THREE.Vector3(0,0,1);s.setFromAxisAngle(i,t),h.setFromAxisAngle(o,n),d.multiply(s).multiply(h),p.alpha+=THREE.Math.radToDeg(t),p.beta+=THREE.Math.radToDeg(n),p.alpha=Math.sign(p.alpha)*(Math.abs(p.alpha)-360*Math.floor(Math.abs(p.alpha)/360)),p.beta=Math.sign(p.beta)*(Math.abs(p.beta)-360*Math.floor(Math.abs(p.beta)/360)),e=!0}if(c.autoRotateSpeedX||c.autoRotateSpeedY){t=THREE.Math.degToRad(c.autoRotateSpeedX/10),n=THREE.Math.degToRad(-c.autoRotateSpeedY/10),o=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,1,0);s.setFromAxisAngle(i,t),h.setFromAxisAngle(o,n),d.multiply(s).multiply(h),p.alpha+=THREE.Math.radToDeg(t),p.beta+=THREE.Math.radToDeg(n),p.alpha=Math.sign(p.alpha)*(Math.abs(p.alpha)-360*Math.floor(Math.abs(p.alpha)/360)),p.beta=Math.sign(p.beta)*(Math.abs(p.beta)-360*Math.floor(Math.abs(p.beta)/360)),e=!0}e&&(c.material.uniforms.transform.value.makeRotationFromQuaternion(d),c.dispatchEvent(m))}else c.material.uniforms.transform.value.makeRotationFromQuaternion(d)},this.bind=function(){c.canvas.addEventListener("mousedown",y,!1),c.canvas.addEventListener("mousemove",w,!1),c.canvas.addEventListener("mouseup",b,!1),c.canvas.addEventListener("touchstart",y,!1),c.canvas.addEventListener("touchmove",w,!1),c.canvas.addEventListener("touchend",b,!1),c.canvas.addEventListener("keydown",R,!1),c.canvas.addEventListener("keyup",_,!1),c.canvas.addEventListener("mousewheel",T,!1),c.canvas.addEventListener("DOMMouseScroll",T,!1)},this.unbind=function(){l=!1,c.canvas.removeEventListener("mousedown",y,!1),c.canvas.removeEventListener("mousemove",w,!1),c.canvas.removeEventListener("mouseup",b,!1),c.canvas.removeEventListener("touchstart",y,!1),c.canvas.removeEventListener("touchmove",w,!1),c.canvas.removeEventListener("touchend",b,!1),c.canvas.removeEventListener("keydown",R,!1),c.canvas.removeEventListener("keyup",_,!1),c.canvas.removeEventListener("mousewheel",T,!1),c.canvas.removeEventListener("DOMMouseScroll",T,!1)},this.getAlphaBetaPos=function(){return{alpha:p.alpha,beta:-p.beta}},this.setAlphaBetaPos=function(e,t){p.alpha=e,p.beta=-t;var n=THREE.Math.degToRad(p.alpha),o=THREE.Math.degToRad(p.beta);s=new THREE.Quaternion,h=new THREE.Quaternion,d=new THREE.Quaternion,s.setFromAxisAngle(c.vectorY,0),h.setFromAxisAngle(c.vectorX,0),d.multiply(s).multiply(h),c.update(),s.setFromAxisAngle(c.vectorY,n),h.setFromAxisAngle(c.vectorX,o),d.multiply(s).multiply(h),c.update();var i=new $.Deferred;return i.resolve(),i.promise()},this.lookAt=function(e){console.warn("IPANORAMA.LittlePlanetControls: lookAt is unused method.");var t=new $.Deferred;return t.resolve(),t.promise()},this.getZoom=function(){return c.material.uniforms.zoom.value},this.setZoom=function(e){e&&(e=Math.max(c.minZoom,Math.min(c.maxZoom,e)),c.material.uniforms.zoom.value=e,c.update())},this.destroy=function(){this.unbind()}};LittlePlanetControls.prototype=Object.create(THREE.EventDispatcher.prototype),LittlePlanetControls.prototype.constructor=LittlePlanetControls;var SceneLittlePlanet=function(e,t,n){SceneBase.call(this,e,t,n),this.image=t.image,this.size=1e4,this.ratio=.5,this.texture=null,this.geometry=new THREE.PlaneGeometry(this.size,this.size*this.ratio),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:new THREE.Texture},resolution:{value:1},transform:{value:new THREE.Matrix4},zoom:{value:this.size},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","const float PI = 3.141592653589793;","uniform sampler2D texture;","uniform float resolution;","uniform mat4 transform;","uniform float zoom;","uniform float opacity;","void main() {","vec2 position = -1.0 +  2.0 * vUv;","position *= vec2( zoom * resolution, zoom * 0.5 );","float x2y2 = position.x * position.x + position.y * position.y;","vec3 sphere_pnt = vec3(2.0 * position, x2y2 - 1.0) / (x2y2 + 1.0);","sphere_pnt = vec3( transform * vec4(sphere_pnt, 1.0) );","vec2 sampleUV = vec2(","(atan(sphere_pnt.y, sphere_pnt.x) / PI + 1.0) * 0.5,","(asin(sphere_pnt.z) / PI + 0.5)",");","vec4 color = texture2D( texture, sampleUV );","color.a *= opacity;","gl_FragColor = color;","}"].join("\n"),side:THREE.DoubleSide}),this.material.uniforms.resolution.value=e.clientWidth/e.clientHeight,this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh),this.control=new LittlePlanetControls(e,this.material,this),this.autoRotateControl=new AutoRotateControl(this,t.autoRotate)};SceneLittlePlanet.prototype=Object.create(SceneBase.prototype),SceneLittlePlanet.prototype.constructor=SceneLittlePlanet,Object.assign(SceneLittlePlanet.prototype,{update:function(){this.control.update(),SceneBase.prototype.update.call(this)},load:function(e){if(SceneBase.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneLittlePlanet: image source undefined"),void this.onError;"string"==typeof e?(this.smartRequest&&this.smartRequest.abort(),Utils.TextureLoader.load(e,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest)):e instanceof HTMLImageElement&&this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){SceneBase.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),SceneBase.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),SceneBase.prototype.onHideStart.call(this)},onWindowResize:function(e,t){this.material.uniforms.resolution.value=e/t,SceneBase.prototype.onWindowResize.call(this,e,t)},get:function(e){return e&&this.load(this.image),SceneBase.prototype.get.call(this)},destroy:function(){this.control.destroy(),this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,SceneBase.prototype.destroy.call(this)},bind:function(){this.control.bind(),this.autoRotateControl.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind()}});var FlatControls=function(e,t,n){this.canvas=e,this.camera=t,this.scene=n,(this.scene.control=this).imageSize={width:0,height:0},this.enabled=!0,this.momentumThreshold=2,this.momentumDampingFactor=.5,this.noZoom=!1,this.noRotate=!1,this.autoRotate=!1,this.autoRotateSpeedX=.5,this.noKeys=!1,this.keyPanSpeed=7,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var o,i,a,r,d=this,s=$(e),c=new THREE.Vector2,l=new THREE.Vector2,u=new THREE.Vector2,p=new Utils.Matrix,h={alpha:0,beta:0},m=null,f=!1,v=Date.now(),g=0,E=0,y=0,w=0,b=0,T=0,_=null,R=-1,x=2,S=3,M=5,P=R,H={type:"change"},C={type:"start"},A={type:"end"};this.rotateLeft=function(e){e&&this.setDeltaPosition(e,0)},this.rotateUp=function(e){e&&this.setDeltaPosition(0,-e)},this.update=function(){d.autoRotate&&P===R&&d.setDeltaPosition(d.autoRotateSpeedX,0),k()},this.bind=function(){s.on("mousedown",O),s.on("touchstart",V),s.on("touchmove",j),s.on("touchend",N),s.on("mousewheel",B),s.on("DOMMouseScroll",B),s.on("keydown",F),s.on("keyup",z)},this.unbind=function(){s.off("mousedown",O),s.off("touchstart",V),s.off("touchmove",j),s.off("touchend",N),s.off("mousewheel",B),s.off("DOMMouseScroll",B),$(document).off("mousemove",I),$(document).off("mouseup",D)},this.getAlphaBetaPos=function(){var e=d.getPosition();return{alpha:e.x,beta:e.y}},this.setAlphaBetaPos=function(e,t){h.alpha=e,h.beta=t,d.setPosition(e,t);var n=new $.Deferred;return n.resolve(),n.promise()},this.lookAt=function(e){console.warn("IPANORAMA.FlatControls: lookAt is unused method");var t=new $.Deferred;return t.resolve(),t.promise()},this.getPosition=function(){return{x:p.m[4],y:p.m[5]}},this.setPosition=function(e,t){p.m[4]=e,p.m[5]=t,L()},this.setDeltaPosition=function(e,t){var n=p.inverse().transformPoint(e,t),o=p.inverse().transformPoint(0,0),i=n[0]-o[0],a=n[1]-o[1];p.translate(i,a),L()},this.getMinZoom=function(){var e=d.canvas.clientWidth/d.imageSize.width,t=d.canvas.clientHeight/d.imageSize.height;return e<t?t:e},this.getZoom=function(){return p.m[0]},this.setZoom=function(e){e&&(m=e),e=e||1e-6;var t=d.getPosition();p.reset().translate(t.x,t.y).scale(e,e),L()},this.setDeltaZoom=function(e,t){t=t||{x:p.m[4],y:p.m[5]};var n=p.inverse().transformPoint(t.x,t.y),o=n[0],i=n[1];p.translate(o,i).scale(e,e).translate(-o,-i),L()},this.getFocalPoint=function(e,t){var n=d.canvas.getBoundingClientRect(),o=new THREE.Vector2;return o.x=e-n.left-n.width/2,o.y=-(t-n.top-n.height/2),o},this.resize=function(){d.setZoom(d.getZoom())},this.reinit=function(){d.setZoom(m),(h.alpha||h.beta)&&d.setPosition(h.alpha,h.beta)},this.save=function(){m=p.m[0],h.alpha=p.m[4],h.beta=p.m[5]};var L=function(){var e=d.getPosition(),t=d.getZoom(),n=d.canvas.clientWidth,o=d.canvas.clientHeight,i=d.imageSize.width,a=d.imageSize.height,r=i*t,s=a*t;if(r<n||s<o){var c=n/i,l=o/a;t=c<l?l:c,p.reset().translate(e.x,e.y).scale(t,t),r=i*t,s=a*t}var u=r,h=(s-o)/2;(e.x<-u||e.x>u)&&(e.x=0),e.y<-h?e.y=-h:e.y>h&&(e.y=h),e.x=isNaN(e.x)?0:e.x,e.y=isNaN(e.y)?0:e.y,p.m[4]=e.x,p.m[5]=e.y,d.camera.zoom=t,d.camera.position.set(-e.x/t,-e.y/t,0),d.camera.updateProjectionMatrix(),d.dispatchEvent(H),d.scene&&d.scene.$canvas.trigger("ipanorama:scene-camera-change",{scene:d.scene})},k=function(){if(f){if(Math.abs(g)<1e-4&&Math.abs(E)<1e-4)return f=!1,void(n.afterRender=!0);var e=Date.now()-v;v=Date.now(),y*=d.momentumDampingFactor,w*=d.momentumDampingFactor,g=y*e,E=w*e,u.x+=g,u.y+=E,d.setDeltaPosition(u.x,-u.y)}},O=function(e){!1!==d.enabled&&(f=!1,g=E=0,v=Date.now(),P=x,c.set(e.clientX,e.clientY),d.dispatchEvent(C),d.scene&&d.scene.$canvas.trigger("ipanorama:scene-camera-start",{scene:d.scene}),$(document).on("mousemove",I),$(document).on("mouseup",D))},I=function(e){if(!1!==d.enabled&&!0!==d.noRotate){if(e.preventDefault(),_){g=e.clientX-_.clientX,E=e.clientY-_.clientY;var t=Date.now()-v;y=g/t,w=E/t,v=Date.now()}_=e,l.set(e.clientX,e.clientY),u.subVectors(l,c),d.setDeltaPosition(u.x,-u.y),c.copy(l)}},D=function(e){!1!==d.enabled&&(f=!(Math.abs(g)<d.momentumThreshold&&Math.abs(E)<d.momentumThreshold),_=null,$(document).off("mousemove",I),$(document).off("mouseup",D),d.dispatchEvent(A),d.scene&&d.scene.$canvas.trigger("ipanorama:scene-camera-end",{scene:d.scene}),P=R,n.afterRender=!0)},B=function(e){if(!1!==d.enabled&&!0!==d.noZoom&&P===R){e.preventDefault(),e.stopPropagation();var t=0,n=1,o=d.getMinZoom(),i=d.getFocalPoint(e.clientX,e.clientY);void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),n=1+.05*(t=Math.max(-1,Math.min(1,t))),d.getZoom()*n<o&&(n=o/d.getZoom()),d.setDeltaZoom(n,i)}},F=function(e){if(!1!==d.enabled&&!0!==d.noKeys){switch(e.keyCode){case d.keys.UP:o=!0;break;case d.keys.BOTTOM:i=!0;break;case d.keys.LEFT:a=!0;break;case d.keys.RIGHT:r=!0}(o||i||a||r)&&(o&&d.setDeltaPosition(0,-d.keyPanSpeed),i&&d.setDeltaPosition(0,d.keyPanSpeed),a&&d.setDeltaPosition(d.keyPanSpeed,0),r&&d.setDeltaPosition(-d.keyPanSpeed,0))}},z=function(e){switch(e.keyCode){case d.keys.UP:o=!1;break;case d.keys.BOTTOM:i=!1;break;case d.keys.LEFT:a=!1;break;case d.keys.RIGHT:r=!1}},V=function(e){if(f=!1,g=E=0,v=Date.now(),!1!==d.enabled){switch(e.touches.length){case 1:if(!0===d.noRotate)return;P=S,c.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(!0===d.noZoom)return;P=M;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(t*t+n*n);b=o,T=d.getZoom();break;default:P=R}P!==R&&(d.dispatchEvent(C),d.scene&&d.scene.$canvas.trigger("ipanorama:scene-camera-start",{scene:d.scene}))}},j=function(e){if(!1!==d.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!0===d.noRotate)return;if(P!==S)return;if(_){g=e.touches[0].pageX-_.pageX,E=e.touches[0].pageY-_.pageY;var t=Date.now()-v;y=g/t,w=E/t,v=Date.now()}_={pageX:e.touches[0].pageX,pageY:e.touches[0].pageY},l.set(e.touches[0].pageX,e.touches[0].pageY),u.subVectors(l,c),d.setDeltaPosition(u.x,-u.y),c.copy(l);break;case 2:if(!0===d.noZoom)return;if(P!==M)return;var n=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(n*n+o*o),a=(i-b)/b,r=Math.max(d.getMinZoom(),T+a);d.setZoom(r),d.setDeltaPosition(0,0)}},N=function(e){!1!==d.enabled&&(f=!(Math.abs(g)<d.momentumThreshold&&Math.abs(E)<d.momentumThreshold),_=void 0,d.dispatchEvent(A),d.scene&&d.scene.$canvas.trigger("ipanorama:scene-camera-end",{scene:d.scene}),P=R)};this.update()};FlatControls.prototype=Object.create(THREE.EventDispatcher.prototype),FlatControls.prototype.constructor=FlatControls;var PointEditorFlat=function(s,e){this.cfg=e,this.enabled=e.enabled,this.defaultPoint={image:e.image,width:e.width,height:e.height,opacity:e.opacity},this.transformControl=new TransformControls(s.canvas,s.camera),s.scene.add(this.transformControl);var o=this,n=27,i=46,c=new THREE.Raycaster,a=this.transformControl;this.bind=function(){s.$canvas.on("keydown",t),s.$canvas.on("keyup",r),s.$canvas.on("click",l),s.$canvas.on("dblclick",u),a.addEventListener("dragging-changed",h)},this.unbind=function(){s.$canvas.off("keydown",t),s.$canvas.off("keyup",r),s.$canvas.off("click",l),s.$canvas.off("dblclick",u),a.removeEventListener("dragging-changed",h)},this.detach=function(){a.detach()},this.attach=function(e){e&&a.attach(e.mesh)},this.getSceneIntersectPoint=function(e,t){var n=s.canvas.getBoundingClientRect(),o=new THREE.Vector2;o.x=(e-n.left)/n.width*2-1,o.y=-(t-n.top)/n.height*2+1,c.setFromCamera(o,s.camera);var i=c.intersectObjects([s.mesh],!1);if(i.length){var a=i[0].point,r=new THREE.Vector3;return a.x<-s.imageSize.width/2?a.x+=s.imageSize.width:a.x>s.imageSize.width/2&&(a.x-=s.imageSize.width),a.z=0,s.mesh.getWorldPosition(r),new THREE.Vector3(parseFloat((a.x-r.x).toFixed(2)),parseFloat((a.y-r.y).toFixed(2)),parseFloat((a.z-r.z).toFixed(2)))}return null},this.addPointToCenter=function(e){return s.addPoint(o.createPoint({x:0,y:0,z:0}),e)},this.createPoint=function(e){return new Point({pos:e,image:o.defaultPoint.image,width:o.defaultPoint.width,height:o.defaultPoint.height,opacity:o.defaultPoint.opacity})};var t=function(e){o.enabled},r=function(e){if(!1!==o.enabled&&a.object)switch(e.keyCode){case i:if("point"==a.object.userData.type){var t=s.findPointByMesh(a.object);a.detach(),s.removePoint(t)}break;case n:a.detach()}},l=function(e){if(!1!==o.enabled){var t=o.getSceneIntersectPoint(e.clientX,e.clientY);c.set(t,new THREE.Vector3(0,0,1));var n=c.intersectObjects(s.scene.children);if(1<n.length&&"point"===n[1].object.userData.type)return a.attach(n[1].object),void s.selectPoint(a.object.userData.point);a.object&&s.deselectPoint(a.object.userData.point),a.detach()}},u=function(e){if(!1!==o.enabled){var t=o.getSceneIntersectPoint(e.clientX,e.clientY);s.addPoint(o.createPoint(t))}},h=function(e){e.value?s.dragstartPoint(e.target.object.userData.point):s.dragendPoint(e.target.object.userData.point),s.control.enabled=!e.value,s.updatePointPos()}},PointControlFlat=function(a){var r=this,i=new THREE.Frustum,s=null;this.bind=function(){a.control.addEventListener("change",e),a.control.addEventListener("start",t),a.control.addEventListener("end",o)},this.unbind=function(){a.control.removeEventListener("change",e),a.control.removeEventListener("start",t),a.control.removeEventListener("end",o)},this.update=function(){i.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++){var n=[0,0,0];e=a.pointsLeft[t],n[0]=c(i,e,!0),e=a.pointsRight[t],n[1]=c(i,e,!0),e=a.points[t],n[2]=c(i,e,!0);var o=n[0]+n[1]+n[2];1==o?(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.$canvas.trigger("ipanorama:scene-point-show",{scene:a,point:e})):2==o&&(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.$canvas.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))}},this.show=function(){i.setFromMatrix((new THREE.Matrix4).multiplyMatrices(a.camera.projectionMatrix,a.camera.matrixWorldInverse));for(var e=null,t=0;t<a.points.length;t++){var n=[0,0,0];(e=a.pointsLeft[t]).mesh.visible=!0,n[0]=c(i,e,!1),(e=a.pointsRight[t]).mesh.visible=!0,n[1]=c(i,e,!1),(e=a.points[t]).mesh.visible=!0,n[2]=c(i,e,!1);var o=n[0]+n[1]+n[2];1==o?(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.$canvas.trigger("ipanorama:scene-point-show",{scene:a,point:e})):2==o&&(e=1==n[0]?a.pointsLeft[t]:1==n[1]?a.pointsRight[t]:e,a.$canvas.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))}},this.hide=function(){for(var e=0;e<a.points.length;e++){var t=a.points[e];n(t),t=a.pointsLeft[e],n(t),t=a.pointsRight[e],n(t)}},this.getScreenCoord=function(e){return e.project(a.camera),e.x=Math.round((.5+e.x/2)*(a.canvas.width/window.devicePixelRatio)),e.y=Math.round((.5-e.y/2)*(a.canvas.height/window.devicePixelRatio)),{x:e.x,y:e.y}};var n=function(e){e.mesh.visible=!1,e.visible&&(e.visible=!1,a.$canvas.trigger("ipanorama:scene-point-hide",{scene:a,point:e}))},c=function(e,t,n){var o=0;return e.containsPoint(t.mesh.position)?(l(t),t.visible||(t.visible=!0,o=1),n&&a.$canvas.trigger("ipanorama:scene-point-change",{scene:a,point:t})):t.visible&&(t.visible=!1,o=2),o},l=function(e){e.mesh.quaternion.copy(a.camera.quaternion);var t=e.mesh.position.clone();if(e.screenPos=r.getScreenCoord(t),s!=a.camera.zoom){e.mesh.updateMatrixWorld();var n=e.mesh.geometry.vertices[0].clone(),o=e.mesh.geometry.vertices[1].clone(),i=e.mesh.geometry.vertices[2].clone();n.applyMatrix4(e.mesh.matrixWorld),o.applyMatrix4(e.mesh.matrixWorld),i.applyMatrix4(e.mesh.matrixWorld),n=r.getScreenCoord(n),o=r.getScreenCoord(o),i=r.getScreenCoord(i),e.screenWidth=o.x-n.x,e.screenHeight=i.y-n.y,s=a.camera.zoom}},e=function(){r.update()},t=function(){},o=function(){}},SceneFlat=function(e,t,n){SceneBase.call(this,e,t,n),this.image=t.image,this.imageSize={width:0,height:0},this.texture=null,this.geometry=new THREE.PlaneBufferGeometry(1,1,3,1),this.material=new THREE.ShaderMaterial({uniforms:{texture:{value:null},imageSize:{value:new THREE.Vector2},imageOriginalSize:{value:new THREE.Vector2},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture;","uniform vec2 imageSize;","uniform vec2 imageOriginalSize;","uniform float opacity;","void main() {","vec2 uv = vUv;","float ratio_x = imageOriginalSize.x / imageSize.x;","float ratio_y = imageOriginalSize.y / imageSize.y;","float blocks = 3.0;","if(uv.x >= (2.0/blocks)) {","uv = vec2((uv.x - 2.0/blocks) * ratio_x * blocks, 1.0 - (1.0 - uv.y) * ratio_y);","} else if(uv.x >= (1.0/blocks)) {","uv = vec2((uv.x - 1.0/blocks) * ratio_x * blocks, 1.0 - (1.0 - uv.y) * ratio_y);","} else if(uv.x >= (0.0/blocks)) {","uv = vec2((uv.x - 0.0/blocks) * ratio_x * blocks, 1.0 - (1.0 - uv.y) * ratio_y);","}","vec4 color = texture2D(texture, uv);","color.a *= opacity;","gl_FragColor = color;","}"].join("\n"),side:THREE.DoubleSide,transparent:!0}),this.mesh=new THREE.Mesh(this.geometry,this.material),this.scene=new THREE.Scene,this.scene.add(this.mesh);var o=this.canvas.clientWidth/2,i=this.canvas.clientHeight/2;this.camera=new THREE.OrthographicCamera(-o,o,i,-i,-1e4,1e4),this.control=new FlatControls(e,this.camera,this),this.autoRotateControl=new AutoRotateControl(this,t.autoRotate),this.points=[],this.pointsLeft=[],this.pointsRight=[],this.pointEditor=new PointEditorFlat(this,t.pointEditor),this.pointControl=new PointControlFlat(this)};SceneFlat.prototype=Object.create(SceneBase.prototype),SceneFlat.prototype.constructor=SceneFlat,Object.assign(SceneFlat.prototype,{update:function(){this.control.update(),SceneBase.prototype.update.call(this)},load:function(e){if(SceneBase.prototype.load.call(this),this.image=e||this.image,!e)return console.warn("IPANORAMA.SceneFlat: image source undefined"),void this.onError();"string"==typeof e?(this.smartRequest&&this.smartRequest.abort(),Utils.TextureLoader.load(e,this.onLoad.bind(this),this.onProgress.bind(this),this.onError.bind(this),this.smartRequest,!0)):e instanceof HTMLImageElement&&this.onLoad(new THREE.Texture(e))},onLoad:function(e){this.texture&&this.texture.dispose(),this.texture=e,this.texture.minFilter=this.texture.magFilter=THREE.LinearFilter,this.texture.wrapS=this.texture.wrapT=THREE.RepeatWrapping,this.texture.needsUpdate=!0,this.material.uniforms.texture.value=this.texture,this.material.uniforms.imageSize.value.width=this.texture.image.width,this.material.uniforms.imageSize.value.height=this.texture.image.height,this.material.uniforms.imageOriginalSize.value.width=this.texture.imageOriginalSize.width,this.material.uniforms.imageOriginalSize.value.height=this.texture.imageOriginalSize.height,this.mesh.scale.set(3*this.texture.imageOriginalSize.width,this.texture.imageOriginalSize.height,1),this.control.imageSize.width=this.imageSize.width=this.texture.imageOriginalSize.width,this.control.imageSize.height=this.imageSize.height=this.texture.imageOriginalSize.height,this.control.reinit(),this.updatePointPos(),this.pointControl.show(),window.requestAnimationFrame(function(){window.requestAnimationFrame(function(){SceneBase.prototype.onLoad.call(this)}.bind(this))}.bind(this))},onShowStart:function(){this.bind(),this.pointControl.show(),SceneBase.prototype.onShowStart.call(this)},onHideStart:function(){this.unbind(),this.pointControl.hide(),this.control.save(),SceneBase.prototype.onHideStart.call(this)},onWindowResize:function(e,t){this.camera.left=-e/2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=-t/2,this.camera.updateProjectionMatrix(),this.control.resize(),SceneBase.prototype.onWindowResize.call(this,e,t)},get:function(e){return e&&this.load(this.image),SceneBase.prototype.get.call(this)},destroy:function(){this.scene.remove(this.mesh),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose(),this.texture&&this.texture.dispose(),this.mesh=void 0,SceneBase.prototype.destroy.call(this)},updatePointPos:function(){for(var e=null,t=0;t<this.points.length;t++)e=this.points[t].mesh.position,this.pointsLeft[t].mesh.position.set(e.x-this.imageSize.width,e.y,e.z),this.pointsRight[t].mesh.position.set(e.x+this.imageSize.width,e.y,e.z)},addPoint:function(e,t){if(!e)return null;var n=new IPANORAMA.Point(e.cfg),o=new IPANORAMA.Point(e.cfg);return e.mesh.userData.type="point",n.mesh.userData.type="pointLeft",o.mesh.userData.type="pointRight",e.ext&&(n.ext=e.ext,o.ext=e.ext),n.load(),this.pointsLeft.push(n),this.scene.add(n.mesh),o.load(),this.pointsRight.push(o),this.scene.add(o.mesh),e.load(),this.points.push(e),this.scene.add(e.mesh),!t&&this.$canvas.trigger("ipanorama:scene-point-add",{scene:this,point:e}),this.loaded&&(this.updatePointPos(),this.pointControl.show()),e},removePoint:function(e,t){if(e){for(var n=null,o=0;o<this.points.length;o++)Object.is(e,this.points[o])&&(n=o);null!=n&&(this.pointEditor&&this.pointEditor.detach(),e=this.pointsLeft[n],this.scene.remove(e.mesh),e.destroy(),e=this.pointsRight[n],this.scene.remove(e.mesh),e.destroy(),e=this.points[n],this.scene.remove(e.mesh),e.destroy(),this.pointsLeft.splice(n,1),this.pointsRight.splice(n,1),this.points.splice(n,1),!t&&this.$canvas.trigger("ipanorama:scene-point-remove",{scene:this,point:e}))}},removePoints:function(e){this.pointEditor&&this.pointEditor.detach();for(var t=null,n=0;n<this.points.length;n++)t=this.pointsLeft[n],this.scene.remove(t.mesh),t.destroy(),t=this.pointsRight[n],this.scene.remove(t.mesh),t.destroy(),t=this.points[n],this.scene.remove(t.mesh),t.destroy(),!e&&this.$canvas.trigger("ipanorama:scene-point-remove",{scene:this,point:t});this.pointsLeft=[],this.pointsRight=[],this.points=[]},bind:function(){this.control.bind(),this.autoRotateControl.bind(),this.pointEditor.bind(),this.pointControl.bind()},unbind:function(){this.control.unbind(),this.autoRotateControl.unbind(),this.pointEditor.unbind(),this.pointControl.unbind()}});var SceneTransitionEffectDefault={name:"default",effect:function(e,t){this.viewer=t,this.shader={uniforms:{texture1:{value:null},texture2:{value:null},progress:{value:0},time:{value:0},timeDelta:{value:0},resolution:{value:new THREE.Vector2}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture1;","uniform sampler2D texture2;","uniform float progress;","uniform float time;","uniform float timeDelta;","uniform vec2 resolution;","void main() {","vec2 uv = vUv;","vec4 texel1 = texture2D( texture1, uv );","vec4 texel2 = texture2D( texture2, uv );","gl_FragColor = mix(texel1, texel2, progress);","}"].join("\n"),side:THREE.DoubleSide},this.material=new THREE.ShaderMaterial(this.shader),this.init(e)}};SceneTransitionEffectDefault.effect.prototype={init:function(e){},getMaterial:function(){return this.material},destroy:function(){this.material.dispose()},onStart:function(e,t,n){},onUpdate:function(e,t,n){},onComplete:function(e,t){}};var SceneTransitionEffectSimpleZoom={name:"simplezoom",effect:function(e,t){this.viewer=t,this.shader={uniforms:{texture1:{value:null},texture2:{value:null},progress:{value:0},time:{value:0},timeDelta:{value:0},resolution:{value:new THREE.Vector2},quickness:{value:.3}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D texture1;","uniform sampler2D texture2;","uniform float progress;","uniform float time;","uniform float timeDelta;","uniform vec2 resolution;","const float PI = 3.141592653589793;","uniform float quickness;","float nQuick = clamp(quickness,0.2,1.0);","vec2 zoom(vec2 uv, float amount) {","return 0.5 + ((uv - 0.5) * (1.0-amount));","}","void main() {","vec2 uv = vUv;","vec4 texel1 = texture2D( texture1, zoom(uv, smoothstep(0.0, nQuick, progress)) );","vec4 texel2 = texture2D( texture2, uv );","gl_FragColor = mix(texel1, texel2, smoothstep(nQuick-0.2, 1.0, progress));","}"].join("\n"),side:THREE.DoubleSide},this.material=new THREE.ShaderMaterial(this.shader),this.init(e)}};SceneTransitionEffectSimpleZoom.effect.prototype={init:function(e){},getMaterial:function(){return this.material},destroy:function(){this.material.dispose()},onStart:function(e,t,n){},onUpdate:function(e,t,n){},onComplete:function(e,t){}};var VIEWERMODES={NORMAL:1,STEREO:2},Viewer=function(e,t){console.log("IPANORAMA",VERSION),THREE.Cache.enabled=!0,this.$canvas=$(e),this.smartRequest=t,this.visible=null!=e.offsetParent,this.enabled=!0;var n=e.clientWidth,o=e.clientHeight;this.updateCallbacks=[],this.requestAnimationId=null,this.mode=VIEWERMODES.NORMAL,this.clock=new THREE.Clock,this.scene=new THREE.Scene,this.sceneDfd=null,this.sceneToLoad=null,this.sceneActive=null,this.sceneTransition=null,this.sceneTransitionDuration=1500,this.sceneTransitionEffect=null,this.camera=new THREE.OrthographicCamera(n/-2,n/2,o/2,o/-2,-10,10),this.quadGeometry=new THREE.PlaneBufferGeometry(1,1),this.quadMaterial=new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,opacity:.5}),this.quad=new THREE.Mesh(this.quadGeometry,this.quadMaterial),this.quad.scale.set(n,o,1),this.scene.add(this.quad),this.renderer=new THREE.WebGLRenderer({canvas:e,alpha:!0,antialias:!1,preserveDrawingBuffer:!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(n,o),this.renderer.setClearColor(0,1),this.renderer.sortObjects=!1,this.initSceneTransition(),this.setSceneTransitionEffect("default"),this.animate()};Viewer.prototype={initSceneTransition:function(){this.sceneTransition=new TWEEN.Tween(this).easing(TWEEN.Easing.Linear.None).onStart(this.onSceneShowStart.bind(this)).onUpdate(this.onSceneShowUpdate.bind(this)).onComplete(this.onSceneShowComplete.bind(this))},animate:function(){this.requestAnimationId=window.requestAnimationFrame(this.animate.bind(this)),this.enabled&&this.onChange()},update:function(){TWEEN.update(void 0,!0),this.sceneActive&&this.sceneActive.update(),this.sceneToLoad&&this.sceneToLoad.update(),this.updateCallbacks.forEach(function(e){e()})},render:function(){var e=null!=this.$canvas.get(0).offsetParent;if(e){if(e!=this.visible&&(this.visible=e,window.dispatchEvent(new Event("resize"))),this.sceneActive||this.sceneToLoad)switch(this.sceneActive&&this.sceneActive.render(this.renderer,!0),this.sceneToLoad&&this.sceneToLoad.render(this.renderer,!0),this.mode){case VIEWERMODES.NORMAL:this.renderer.setRenderTarget(null),this.renderer.clear(),this.renderer.render(this.scene,this.camera);break;case VIEWERMODES.STEREO:var t=new THREE.Vector2;this.renderer.getSize(t),this.renderer.setRenderTarget(null),this.renderer.clear(),this.renderer.setScissorTest(!0),this.renderer.setScissor(0,0,t.width/2,t.height),this.renderer.setViewport(0,0,t.width/2,t.height),this.renderer.render(this.scene,this.camera),this.renderer.setScissor(t.width/2,0,t.width/2,t.height),this.renderer.setViewport(t.width/2,0,t.width/2,t.height),this.renderer.render(this.scene,this.camera),this.renderer.setScissorTest(!1)}}else this.visible=e},onChange:function(){this.update(),this.render()},onWindowResize:function(e,t){this.renderer.setSize(e,t),this.quad.scale.set(e,t,1),this.camera.left=-e/2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=-t/2,this.camera.updateProjectionMatrix(),this.quadMaterial.uniforms&&(this.quadMaterial.uniforms.resolution.value.x=e,this.quadMaterial.uniforms.resolution.value.y=t)},onSceneReadyToShow:function(e){this.sceneToLoad=e,this.sceneTransition.to({},this.sceneTransitionDuration).stop().start()},onSceneError:function(e){},onSceneShowStart:function(){var e=this.sceneActive,t=this.sceneToLoad;this.sceneActive=t,this.sceneToLoad=e,this.quadMaterial.uniforms&&(this.quadMaterial.uniforms.texture1.value=e?e.fbo.texture:null,this.quadMaterial.uniforms.texture2.value=t?t.fbo.texture:null),this.sceneTransitionEffect.onStart(e,t,this.sceneTransitionDuration),e&&e.onHideStart(),t&&t.onShowStart()},onSceneShowUpdate:function(e){var t=this.sceneToLoad,n=this.sceneActive;this.quadMaterial.uniforms&&(this.quadMaterial.uniforms.progress.value=e,this.quadMaterial.uniforms.time.value=this.clock.getElapsedTime(),this.quadMaterial.uniforms.timeDelta.value=this.clock.getDelta()),this.sceneTransitionEffect.onUpdate(t,n,e),t&&t.onHideUpdate(e),n&&n.onShowUpdate(e)},onSceneShowComplete:function(){var e=this.sceneToLoad,t=this.sceneActive;this.sceneToLoad=null,this.sceneTransition.stop(),this.sceneTransitionEffect.onComplete(e,t),e&&e.onHideComplete(),t&&t.onShowComplete()},setMode:function(e){switch(e){case"normal":e=VIEWERMODES.NORMAL;break;case"stereo":e=VIEWERMODES.STEREO;break;default:e=VIEWERMODES.NORMAL}this.mode=e},setScene:function(e,t){t=void 0===t||t,this.sceneDfd&&this.sceneDfd.reject(),this.sceneDfd=null,e?(e.get(t).then(this.onSceneReadyToShow.bind(this,e)).fail(this.onSceneError.bind(this,e)),this.sceneDfd=e.sceneDfd):this.clearScene()},clearScene:function(){this.smartRequest&&this.smartRequest.abort(),this.sceneActive&&this.sceneActive.onHideStart()&&this.sceneActive.onHideComplete(),this.sceneActive=null,this.sceneToLoad=null,this.sceneDfd=null,this.renderer.setRenderTarget(null),this.renderer.clear(0,0),this.$canvas.trigger("ipanorama:scene-clear")},setSceneTransitionDuration:function(e){this.sceneTransitionDuration=void 0===e?0:e},setSceneTransitionEffect:function(e,t){var n=null;for(var o in root.SceneTransitionEffect)if(root.SceneTransitionEffect.hasOwnProperty(o)){var i=root.SceneTransitionEffect[o];if(i.name.toLowerCase()==e.toLowerCase()){n=i;break}}if(null!=n){var a=this.$canvas.get(0).clientWidth,r=this.$canvas.get(0).clientHeight;this.scene.remove(this.quad),this.sceneTransitionEffect&&this.sceneTransitionEffect.destroy(),this.sceneTransitionEffect=new n.effect(t,this),this.quadMaterial&&this.quadMaterial.dispose(),this.quadMaterial=this.sceneTransitionEffect.getMaterial(),this.quad=void 0,this.quad=new THREE.Mesh(this.quadGeometry,this.quadMaterial),this.quad.scale.set(a,r,1),this.scene.add(this.quad)}else console.warn("IPANORAMA.Viewer: can't find a scene transition effect \""+e+'"')},addUpdateCallback:function(e){e&&this.updateCallbacks.push(e)},removeUpdateCallback:function(e){var t=this.updateCallbacks.indexOf(e);e&&0<=t&&this.updateCallbacks.splice(t,1)},destroy:function(){this.scene.remove(this.quad),this.sceneTransitionEffect&&this.sceneTransitionEffect.destroy(),this.sceneTransitionEffect=null,this.quadGeometry&&this.quadGeometry.dispose(),this.quadMaterial&&this.quadMaterial.dispose(),this.quad=void 0,THREE.Cache&&THREE.Cache.enabled&&THREE.Cache.clear(),this.render(),window.cancelAnimationFrame(this.requestAnimationId)}};var AudioPlayer=function(){this.controls={};var n=this,o=null,i=[],t=null;this.init=function(){e(),a()},this.setAudio=function(e){o&&o.unload(),e&&(o=new HOWLER.Howl({src:[e],onload:v,onplay:g,onpause:E})),c()},this.play=function(e){if(e){var t=new HOWLER.Howl({src:[e],onend:y});i.push(t),t.play()}else o&&o.play()},this.pause=function(){o&&o.pause()},this.setLoop=function(e){o&&o.loop(e)},this.setVolume=function(e){e=Math.max(0,Math.min(1,e)),n.controls.$volumeProgress.get(0).style.height=100*e+"%",HOWLER.Howler.volume(e)},this.destroy=function(){o&&o.unload();for(var e=0;e<i.length;e++){i[e].unload()}r()};var e=function(){n.controls.$widget=$("<div>").addClass("ipnrm-audio-player"),n.controls.$volume=$("<div>").addClass("ipnrm-volume"),n.controls.$volumePanel=$("<div>").addClass("ipnrm-volume-panel"),n.controls.$volumeSlider=$("<div>").addClass("ipnrm-volume-slider"),n.controls.$volumeTrack=$("<div>").addClass("ipnrm-volume-track"),n.controls.$volumeProgress=$("<div>").addClass("ipnrm-volume-progress"),n.controls.$volumeHandle=$("<div>").addClass("ipnrm-volume-handle"),n.controls.$volumeProgress.append(n.controls.$volumeHandle),n.controls.$volumeTrack.append(n.controls.$volumeProgress),n.controls.$volumeSlider.append(n.controls.$volumeTrack),n.controls.$volumePanel.append(n.controls.$volumeSlider),n.controls.$widget.append(n.controls.$volume,n.controls.$volumePanel)},a=function(){n.controls.$volume.on("click",l),n.controls.$widget.on("mouseenter",u),n.controls.$widget.on("mouseleave",h),n.controls.$volumeSlider.on("click",d),n.controls.$volumeSlider.on("mousedown",p)},r=function(){n.controls.$volume.off("click",l),n.controls.$widget.off("mouseenter",u),n.controls.$widget.off("mouseleave",h),n.controls.$volumeSlider.off("click",d),n.controls.$volumeSlider.off("mousedown",p)},s=function(e,t){var n=t.getBoundingClientRect();return 1-(e.clientY-n.top)/n.height},c=function(){o&&(o.playing()?n.controls.$widget.removeClass("ipnrm-mute"):n.controls.$widget.addClass("ipnrm-mute"))},l=function(e){o&&(o.playing()?o.pause():o.play())},u=function(e){clearTimeout(t),n.controls.$widget.addClass("ipnrm-volume-panel-active")},h=function(e){t=setTimeout(function(){n.controls.$widget.removeClass("ipnrm-volume-panel-active")},300)},d=function(e){var t=s(e,n.controls.$volumeSlider.get(0));n.setVolume(t)},p=function(e){e.preventDefault(),document.addEventListener("mousemove",m),document.addEventListener("mouseup",f)},m=function(e){var t=s(e,n.controls.$volumeSlider.get(0));t=t<0?t=0:1<t?t=1:t,n.setVolume(t)},f=function(e){document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",f)},v=function(){c()},g=function(){c()},E=function(){c()},y=function(){for(var e=0;e<i.length;e++){var t=i[e];!t.playing()&&t.unload();break}e<i.length&&i.splice(e,1)}},WidgetDefault={name:"default",defaultConfig:{titleControl:!0,audioControl:!0,prevSceneControl:!0,nextSceneControl:!0,fullscreenControl:!0,thumbnailControl:!1,viewerModeControl:!1,moveToNextScene:!0},widget:function(e,t,o,n){n&&(o=root.Utils.extend(n,o)),this.audioPlayer=new AudioPlayer;var i=this,a=root.$,r=a(e),s=a(t),c=a("<div>").addClass("ipnrm-placeholder").css({display:"none"}),l={},u=null,h=null,d=null,p=[],m=null,f=null,v=!1,g=null;this.init=function(){i.audioPlayer.init(),E(),y()},this.setAudio=function(e){e.src?(f!==e.src&&(f=e.src,i.audioPlayer.setAudio(e.src),e.loop&&i.audioPlayer.setLoop(e.loop),e.volume&&i.audioPlayer.setVolume(e.volume),e.autoPlay&&i.audioPlayer.play()),l.$audioPlayer.addClass("ipnrm-active")):e.stopPrevious&&(i.audioPlayer.setAudio(),f=null,l.$audioPlayer.removeClass("ipnrm-active"))},this.destroy=function(){w(),l.$widget.remove(),l={},s.removeClass("ipnrm-widget-default"),i.audioPlayer.destroy()};var E=function(){s.addClass("ipnrm-widget-default"),l.$widget=a("<div>").addClass("ipnrm-widget"),l.$firstLoad=a("<div>").addClass("ipnrm-first-load"),l.$ts=a("<div>").addClass("ipnrm-ts"),l.$bs=a("<div>").addClass("ipnrm-bs"),l.$tlBar=a("<div>").addClass("ipnrm-tl-bar"),l.$trBar=a("<div>").addClass("ipnrm-tr-bar"),l.$brBar=a("<div>").addClass("ipnrm-br-bar"),l.$blBar=a("<div>").addClass("ipnrm-bl-bar"),l.$progress=a("<div>").addClass("ipnrm-progress"),l.$progressBar=a("<div>").addClass("ipnrm-progress-bar").appendTo(l.$progress),l.$audioPlayer=i.audioPlayer.controls.$widget,l.$prevScene=a("<div>").addClass("ipnrm-btn ipnrm-prev-scene"),l.$nextScene=a("<div>").addClass("ipnrm-btn ipnrm-next-scene"),l.$vr=a("<div>").addClass("ipnrm-btn ipnrm-vr"),l.$thumbs=a("<div>").addClass("ipnrm-btn ipnrm-thumbs"),l.$fullscreen=a("<div>").addClass("ipnrm-btn ipnrm-fullscreen"),l.$title=a("<div>").addClass("ipnrm-title"),l.$ts.append(l.$tlBar,l.$trBar),l.$bs.append(l.$blBar,l.$brBar),l.$tlBar.append(l.$audioPlayer),l.$trBar.append(l.$prevScene,l.$nextScene),l.$brBar.append(l.$vr,l.$thumbs,l.$fullscreen),l.$blBar.append(l.$title),l.$thumbsWrap=a("<div>").addClass("ipnrm-thumbs-wrap"),l.$thumbsList=a("<div>").addClass("ipnrm-thumbs-list"),l.$thumbsClose=a("<div>").addClass("ipnrm-thumbs-close"),l.$thumbsWrap.append(l.$thumbsList,l.$thumbsClose),l.$widget.append(l.$progress,l.$firstLoad,l.$ts,l.$bs,l.$thumbsWrap),s.append(l.$widget),b(),r.on("ipanorama:config",C).trigger("ipanorama:config")},y=function(){s.on("ipanorama:ready",V),s.on("fullscreenchange mozfullscreenchange webkitfullscreenchange msfullscreenchange",j),r.on("ipanorama:scene-before-load",k),r.on("ipanorama:scene-after-load",$),r.on("ipanorama:scene-progress",L),r.on("ipanorama:scene-error",O),r.on("ipanorama:scene-hide-start",I),r.on("ipanorama:scene-hide-complete",D),r.on("ipanorama:scene-show-start",B),r.on("ipanorama:scene-show-complete",F),r.on("ipanorama:scene-index",z),r.on("ipanorama:mode",A),l.$prevScene.on("click",T),l.$nextScene.on("click",_),l.$vr.on("click",R),l.$fullscreen.on("click",P),l.$thumbs.on("click",x),l.$thumbsList.on("click",".ipnrm-thumb",S),l.$thumbsClose.on("click",M),l.$firstLoad.on("click",H)},w=function(){s.off("ipanorama:ready",V),s.off("fullscreenchange mozfullscreenchange webkitfullscreenchange msfullscreenchange",j),r.off("ipanorama:scene-before-load",k),r.off("ipanorama:scene-after-load",$),r.off("ipanorama:scene-progress",L),r.off("ipanorama:scene-error",O),r.off("ipanorama:scene-hide-start",I),r.off("ipanorama:scene-hide-complete",D),r.off("ipanorama:scene-show-start",B),r.off("ipanorama:scene-show-complete",F),r.off("ipanorama:scene-index",z),r.off("ipanorama:mode",A),l.$prevScene.off("click",T),l.$nextScene.off("click",_),l.$vr.off("click",R),l.$fullscreen.off("click",P),l.$thumbs.off("click",x),l.$thumbsList.off("click",".ipnrm-thumb",S),l.$thumbsClose.off("click",M),l.$firstLoad.on("click",H)},b=function(){l.$firstLoad.addClass("ipnrm-hide"),l.$title.addClass("ipnrm-hide"),l.$audioPlayer.addClass("ipnrm-hide"),l.$prevScene.addClass("ipnrm-hide"),l.$nextScene.addClass("ipnrm-hide"),l.$fullscreen.addClass("ipnrm-hide"),l.$thumbs.addClass("ipnrm-hide"),l.$vr.addClass("ipnrm-hide"),l.$thumbsWrap.addClass("ipnrm-hide")},T=function(e){(m-=1)<0?m=null:r.trigger("ipanorama:set-scene",{id:p[m]})},_=function(e){(m+=1)>=p.length?(m=p.length-1,r.trigger("ipanorama:next-scene")):r.trigger("ipanorama:set-scene",{id:p[m]})},R=function(e){var t=u;switch(t){case"normal":t="stereo";break;case"stereo":t="normal"}r.trigger("ipanorama:mode",{mode:t})},x=function(e){var t=l.$thumbsList.find(".ipnrm-thumb.ipnrm-active");t.removeClass("ipnrm-active"),(t=l.$thumbsList.find('[data-scene-id="'+h+'"]')).addClass("ipnrm-active"),l.$thumbsWrap.addClass("ipnrm-active")},S=function(e){r.trigger("ipanorama:set-scene",{id:a(this).data("scene-id")}),l.$thumbsWrap.removeClass("ipnrm-active")},M=function(e){l.$thumbsWrap.removeClass("ipnrm-active")},P=function(e){if(document.fullscreenEnabled||document.webkitFullscreenEnabled)if(l.$fullscreen.hasClass("ipnrm-active"))try{document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()}catch(e){}else try{var t=s.get(0);t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()}catch(e){}else s.toggleClass("ipnrm-fullscreen-mode"),s.hasClass("ipnrm-fullscreen-mode")?(l.$fullscreen.addClass("ipnrm-active"),c.insertBefore(s),s.detach(),a("body").append(s)):(l.$fullscreen.removeClass("ipnrm-active"),s.detach(),s.insertAfter(c),c.remove()),g._onWindowResize()},H=function(e){d&&(l.$firstLoad.addClass("ipnrm-hide"),r.trigger("ipanorama:set-scene",{id:d}))},C=function(e,t){t&&t.config&&(r.off("ipanorama:config",C),!t.config.autoLoad&&0<t.config.scenes.length&&(l.$firstLoad.removeClass("ipnrm-hide"),d=t.config.scenes[0].id),function(e){for(var t=0;t<e.scenes.length;t++){var n=e.scenes[t];if(n.imageThumb){var o=a("<div>").addClass("ipnrm-thumb").attr({"data-scene-id":n.id}),i=a("<img>").attr({src:n.imageThumb});l.$thumbsList.append(o.append(i))}}}(t.config))},A=function(e,t){if(t&&t.master)switch(u=t.mode){case"normal":l.$vr.removeClass("ipnrm-active");break;case"stereo":l.$vr.addClass("ipnrm-active")}},L=function(e,t){t.progress.loaded<t.progress.total?(v||(l.$progress.addClass("ipnrm-active"),v=!0),l.$progressBar.css({width:t.progress.loaded/t.progress.total*100+"%"})):(v&&(l.$progress.removeClass("ipnrm-active"),v=!1),l.$progressBar.css({width:0}))},k=function(e,t){},$=function(e,t){l.$progress.removeClass("ipnrm-active"),v=!1,l.$firstLoad.addClass("ipnrm-hide"),o.titleControl&&l.$title.removeClass("ipnrm-hide"),o.audioControl&&l.$audioPlayer.removeClass("ipnrm-hide"),o.prevSceneControl&&l.$prevScene.removeClass("ipnrm-hide"),o.nextSceneControl&&l.$nextScene.removeClass("ipnrm-hide"),o.fullscreenControl&&l.$fullscreen.removeClass("ipnrm-hide"),o.thumbnailControl&&l.$thumbs.removeClass("ipnrm-hide"),o.viewerModeControl&&l.$vr.removeClass("ipnrm-hide"),l.$thumbsWrap.removeClass("ipnrm-hide")},O=function(e,t){l.$progress.removeClass("ipnrm-active"),v=!1,b()},I=function(e,t){},D=function(e,t){},B=function(e,t){i.setAudio(t.scene.cfg.audio),t.scene.cfg.title?(l.$title.get(0).innerHTML=t.scene.cfg.title,l.$title.addClass("ipnrm-active")):(l.$title.get(0).innerHTML=null,l.$title.removeClass("ipnrm-active"))},F=function(e,t){},z=function(e,t){if(t)if(h=t.scene.cfg.id,null==m?(p.push(h),m=0):p[m]!=h&&(m+=1,(p=p.slice(0,m)).push(h)),0<m?l.$prevScene.addClass("ipnrm-active"):l.$prevScene.removeClass("ipnrm-active"),m<p.length-1)l.$nextScene.addClass("ipnrm-active");else if(l.$nextScene.removeClass("ipnrm-active"),o.moveToNextScene){for(var n=0;n<t.config.scenes.length;n++){if(t.config.scenes[n].id==h)break}n<t.config.scenes.length-1&&l.$nextScene.addClass("ipnrm-active")}},V=function(e,t){g=t.instance},j=function(e){document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement?l.$fullscreen.addClass("ipnrm-active"):l.$fullscreen.removeClass("ipnrm-active"),setTimeout(function(){g._onWindowResize()},100)}}},WidgetSimple={name:"simple",defaultConfig:{},widget:function(e,t,n,o){this.controls={};var i=this,a=$(e),r=$(t),s=!1;this.init=function(){c(),l()},this.destroy=function(){r.removeClass("ipnrm-widget-simple"),u(),i.controls.$widget.remove(),i.controls={}};var c=function(){r.addClass("ipnrm-widget-simple"),i.controls.$widget=$("<div>").addClass("ipnrm-widget-simple"),i.controls.$progress=$("<div>").addClass("ipnrm-progress"),i.controls.$progressBar=$("<div>").addClass("ipnrm-progress-bar").appendTo(i.controls.$progress),i.controls.$widget.append(i.controls.$progress),r.append(i.controls.$widget)},l=function(){a.on("ipanorama:scene-before-load",h),a.on("ipanorama:scene-after-load",d),a.on("ipanorama:scene-progress",p),a.on("ipanorama:scene-clear",m),a.on("ipanorama:scene-hide-start",f),a.on("ipanorama:scene-hide-complete",v),a.on("ipanorama:scene-show-start",g),a.on("ipanorama:scene-show-complete",E)},u=function(){a.off("ipanorama:scene-before-load",h),a.off("ipanorama:scene-after-load",d),a.off("ipanorama:scene-progress",p),a.off("ipanorama:scene-clear",m),a.off("ipanorama:scene-hide-start",f),a.off("ipanorama:scene-hide-complete",v),a.off("ipanorama:scene-show-start",g),a.off("ipanorama:scene-show-complete",E)},h=function(e,t){},d=function(e,t){i.controls.$progress.removeClass("ipnrm-active"),s=!1},p=function(e,t){t.progress.loaded<t.progress.total?(s||(i.controls.$progress.addClass("ipnrm-active"),s=!0),i.controls.$progressBar.css({width:t.progress.loaded/t.progress.total*100+"%"})):(s&&(i.controls.$progress.removeClass("ipnrm-active"),s=!1),i.controls.$progressBar.css({width:0}))},m=function(e,t){i.controls.$progress.removeClass("ipnrm-active"),s=!1},f=function(e,t){},v=function(e,t){},g=function(e,t){},E=function(e,t){}}};root.VERSION=VERSION,root.TWEEN=TWEEN,root.HOWLER=HOWLER,root.GSVPANO=GSVPANO,root.$=$,root.SmartRequest=SmartRequest,root.Utils=Utils,root.OrbitControls=OrbitControls,root.TransformControls=TransformControls,root.Scene=root.Scene||{},root.Scene.Base=SceneBase,root.Scene.Sphere=SceneSphere,root.Scene.Cube=SceneCube,root.Scene.GoogleStreetView=SceneGoogleStreetView,root.Scene.LittlePlanet=SceneLittlePlanet,root.Scene.Flat=SceneFlat,root.SceneTransitionEffect=root.SceneTransitionEffect||{},root.SceneTransitionEffect.Default=SceneTransitionEffectDefault,root.SceneTransitionEffect.SimpleZoom=SceneTransitionEffectSimpleZoom,root.Point=Point,root.Plane=Plane,root.Viewer=Viewer,root.AudioPlayer=AudioPlayer,root.Widget=root.Widget||{},root.Widget.Default=WidgetDefault,root.Widget.Simple=WidgetSimple});